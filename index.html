<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi de Travail</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles personnalis√©s pour les animations et les overrides sp√©cifiques */
        @keyframes expandAnimation {
            from { transform: translate(-50%, -50%) scale(0.95); opacity: 0.9; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .animate-expand {
            animation: expandAnimation 0.3s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadein {
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeinout {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }
        .animate-fadeinout {
            animation: fadeinout 4s forwards;
        }

        /* Styles d'impression */
        @media print {
            body * {
                visibility: hidden;
            }
            .expanded-card, .expanded-card * {
                visibility: visible;
            }
            .expanded-card {
                position: static !important;
                transform: none !important;
                left: auto !important;
                top: auto !important;
                margin: 0 auto !important;
                width: 100% !important;
                max-width: none !important;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                box-shadow: none !important;
                border: none !important;
                padding: 1rem !important;
                background: white !important;
                color: black !important;
            }
            .expanded-card .close-button,
            .expanded-card .actions {
                display: none !important;
            }
            .card h3, .historique strong {
                color: black !important;
            }
            .historique {
                border-left: 1px solid #ccc !important;
                background: #f9f9f9 !important;
            }
            input, textarea, [contenteditable="true"] {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-blue-50 font-sans text-gray-800 leading-relaxed min-h-screen flex flex-col">

    <header class="bg-gradient-to-r from-gray-800 to-blue-700 text-white p-6 text-center shadow-lg fixed top-0 w-full z-50 box-border h-20 flex items-center justify-between rounded-b-lg">
        <h1 class="flex-grow text-center m-0 text-3xl md:text-4xl lg:text-5xl font-extrabold">Suivi de Travail</h1>
        <div class="flex flex-col items-end gap-1">
            <span id="userIdDisplay" class="text-sm text-gray-200">Non connect√©</span>
            <button id="authBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-all duration-300 ease-in-out shadow-sm">Connexion / Inscription</button>
            <button id="signOutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-all duration-300 ease-in-out shadow-sm hidden">D√©connexion</button>
        </div>
    </header>

    <nav class="flex flex-wrap justify-center bg-gray-700 shadow-md fixed top-20 w-full z-40 box-border h-12 rounded-b-md hidden">
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="objectifs">üéØ Objectifs</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="actions">üìù TO DO</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="actionsTerminees">‚úÖ Actions termin√©es</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="notesReunion">üìã Notes de r√©union</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="sharedItems">üåê Partag√©s</button>
    </nav>

    <main class="flex-grow pt-36 pb-8 hidden">
        <div id="objectifs" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Objectifs</h2>
            <input type="text" id="searchBarObjectifs" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher un objectif...">
            <button class="add-new-item-btn bg-blue-600 text-white border-none px-6 py-3 rounded-lg cursor-pointer text-lg block w-fit mx-auto my-4 shadow-md transition-all duration-300 ease-in-out hover:bg-blue-700 hover:translate-y-[-2px] hover:shadow-lg" data-type="objectifs">‚ûï Ajouter un objectif</button>
            <div id="objectifList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>

        <div id="actions" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">TO DO</h2>
            <input type="text" id="searchBarActions" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher une action...">
            <button class="add-new-item-btn bg-blue-600 text-white border-none px-6 py-3 rounded-lg cursor-pointer text-lg block w-fit mx-auto my-4 shadow-md transition-all duration-300 ease-in-out hover:bg-blue-700 hover:translate-y-[-2px] hover:shadow-lg" data-type="actions">‚ûï Ajouter une action</button>
            <div id="actionList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>

        <div id="actionsTerminees" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Actions termin√©es</h2>
            <input type="text" id="searchBarActionsTerminees" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher une action termin√©e...">
            <div id="actionTermineeList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>

        <div id="notesReunion" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Notes de r√©union</h2>
            <input type="text" id="searchBarNotesReunion" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher une note...">
            <button class="add-new-item-btn bg-blue-600 text-white border-none px-6 py-3 rounded-lg cursor-pointer text-lg block w-fit mx-auto my-4 shadow-md transition-all duration-300 ease-in-out hover:bg-blue-700 hover:translate-y-[-2px] hover:shadow-lg" data-type="notesReunion">‚ûï Ajouter une note de r√©union</button>
            <div id="notesReunionList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>

        <div id="sharedItems" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">√âl√©ments Partag√©s</h2>
            <p class="text-gray-700 mb-4">Ces √©l√©ments ont √©t√© partag√©s publiquement. Ils sont en lecture seule.</p>
            <input type="text" id="searchBarSharedItems" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher un √©l√©ment partag√©...">
            <div id="sharedItemList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>
    </main>

    <div class="overlay hidden fixed inset-0 w-full h-full bg-black bg-opacity-60 z-[999] backdrop-blur-sm animate-fadein" id="overlay"></div>

    <div id="authModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded-lg shadow-2xl z-[2000] max-w-md w-11/12 hidden animate-expand">
        <span class="close-button absolute top-4 right-5 text-3xl font-bold text-gray-400 cursor-pointer z-[1001] p-2 rounded-full leading-none transition-all duration-300 ease-in-out bg-white bg-opacity-20 hover:text-gray-200 hover:bg-opacity-40 hover:scale-110">&times;</span>
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Connexion / Inscription</h3>
        <div class="mb-4">
            <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
            <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="votre@email.com">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Mot de passe:</label>
            <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="********">
        </div>
        <div class="flex flex-col gap-3">
            <button id="signInEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 ease-in-out shadow-md">Se connecter</button>
            <button id="signUpEmailBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 ease-in-out shadow-md">S'inscrire</button>
            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400">OU</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            <button id="signInGoogleBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 ease-in-out shadow-md flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zM8.282 16.92a6.994 6.994 0 011.693-4.322c.23-.393.453-.787.67-1.182h-2.57c-.42 0-.671-.478-.456-.867A7.01 7.01 0 0111.96 6c1.64 0 3.14.568 4.312 1.549.123.102.164.28.106.433l-1.39 3.635a.51.51 0 01-.482.355h-2.12c-.407 0-.77.28-.857.68a4.992 4.992 0 00-.17 1.437c0 1.042.33 2.004.89 2.771.096.128.016.31-.13.364l-1.896.68A7.03 7.03 0 018.282 16.92z" clip-rule="evenodd" /></svg>
                Se connecter avec Google
            </button>
        </div>
    </div>

    <script type="module">
        // Importe les modules Firebase n√©cessaires.
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Configuration Firebase (NE PAS MODIFIER)
        const firebaseConfig = {
            apiKey: "AIzaSyCFMC73NLlmTzGVGcK_-zTwwNyw6-jmr7Y",
            authDomain: "suivitravailapp.firebaseapp.com",
            projectId: "suivitravailapp",
            storageBucket: "suivitravailapp.appspot.com",
            messagingSenderId: "621525076182",
            appId: "1:621525076182:web:f5a9bc1f5aaae71ce7e177",
            measurementId: "G-15HMDGYYCN"
        };

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // --- VARIABLES GLOBALES ---
        let userId = null;
        let expandedCard = null;
        let currentPageId = 'objectifs';
        let unsubscribeListeners = []; // Stocke les fonctions pour se d√©sabonner des √©couteurs Firestore

        // --- CONSTANTES ---
        const COLLECTIONS = {
            OBJECTIFS: 'objectifs',
            ACTIONS: 'actions',
            NOTES_REUNION: 'notesReunion',
            SHARED_ENTRIES: 'shared_entries'
        };

        // --- S√âLECTEURS DOM ---
        const authModal = document.getElementById('authModal');
        const overlay = document.getElementById('overlay');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signInEmailBtn = document.getElementById('signInEmailBtn');
        const signUpEmailBtn = document.getElementById('signUpEmailBtn');
        const signInGoogleBtn = document.getElementById('signInGoogleBtn');
        const authBtn = document.getElementById('authBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const mainContent = document.querySelector('main');
        const nav = document.querySelector('nav');
        
        // --- FONCTIONS UTILITAIRES & MODALES ---

        /**
         * Affiche une bo√Æte de message modale personnalis√©e.
         * @param {string} message Le message √† afficher.
         * @param {boolean} isError Indique s'il s'agit d'un message d'erreur.
         * @param {boolean} showConfirmButtons Si vrai, affiche les boutons 'Oui'/'Non'.
         * @returns {Promise<boolean>} R√©sout √† true si confirm√©, false sinon.
         */
        function showModalMessage(message, isError = false, showConfirmButtons = false) {
            return new Promise(resolve => {
                const messageBox = document.createElement('div');
                messageBox.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-5 rounded-lg shadow-xl z-[3000] text-center font-sans max-w-sm w-11/12 border ${isError ? 'border-red-500 text-red-600' : 'border-blue-600 text-gray-800'} animate-expand`;
                
                const buttonsHtml = showConfirmButtons
                    ? `<button id="confirmYes" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md cursor-pointer mr-2 transition-all duration-300 ease-in-out">Oui</button>
                       <button id="confirmNo" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md cursor-pointer transition-all duration-300 ease-in-out">Non</button>`
                    : `<button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md cursor-pointer mt-4 transition-all duration-300 ease-in-out">OK</button>`;

                messageBox.innerHTML = `<p class="mb-4">${message}</p><div>${buttonsHtml}</div>`;
                document.body.appendChild(messageBox);

                const msgOverlay = document.createElement('div');
                msgOverlay.className = 'fixed inset-0 w-full h-full bg-black bg-opacity-50 z-[2999] animate-fadein';
                document.body.appendChild(msgOverlay);

                const cleanup = (result) => {
                    messageBox.remove();
                    msgOverlay.remove();
                    resolve(result);
                };

                if (showConfirmButtons) {
                    document.getElementById('confirmYes').addEventListener('click', () => cleanup(true));
                    document.getElementById('confirmNo').addEventListener('click', () => cleanup(false));
                } else {
                    messageBox.querySelector('button').addEventListener('click', () => cleanup(true));
                }
                msgOverlay.addEventListener('click', () => cleanup(false));
            });
        }

        /**
         * Affiche une notification toast non-intrusive.
         * @param {string} message Le message √† afficher.
         * @param {string} type Le type de notification ('success', 'info', 'error').
         */
        function showToastNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast-notification fixed bottom-5 left-1/2 -translate-x-1/2 text-white px-5 py-3 rounded-lg shadow-xl z-[3000] opacity-0 animate-fadeinout text-base flex items-center gap-2';
            const icons = { success: '‚úîÔ∏è', error: '‚ùå', info: '‚ÑπÔ∏è' };
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
            
            toast.classList.add(colors[type] || colors['info']);
            toast.innerHTML = `${icons[type] || icons['info']} ${message}`;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 4000);
        }

        /**
         * R√©cup√®re le timestamp actuel au format 'fr-FR'.
         * @returns {string} Le timestamp format√©.
         */
        function getTimeStamp() {
            return new Date().toLocaleString('fr-FR');
        }

        /**
         * Extrait un objet Date d'une cha√Æne d'historique pour le tri.
         * @param {string} dateString La cha√Æne d'historique.
         * @returns {Date} L'objet Date pars√©.
         */
        function extractDateFromHistory(dateString) {
            const match = dateString.match(/(\d{2})\/(\d{2})\/(\d{4}) √† (\d{2}):(\d{2}):(\d{2})/);
            if (match) {
                const [, day, month, year, hour, minute, second] = match.map(Number);
                return new Date(year, month - 1, day, hour, minute, second);
            }
            return new Date(0); // Date par d√©faut si le format est invalide
        }

        /**
         * Redimensionne un textarea pour s'adapter √† son contenu.
         * @param {HTMLTextAreaElement} element L'√©l√©ment textarea √† redimensionner.
         */
        function autoResizeTextarea(element) {
            element.style.height = 'auto';
            element.style.height = `${element.scrollHeight}px`;
        }

        // --- GESTION DE L'INTERFACE (UI) ---

        /**
         * Affiche une page de contenu sp√©cifique et masque les autres.
         * @param {string} id L'ID de la page de contenu √† afficher.
         */
        function showPage(id) {
            currentPageId = id;
            document.querySelectorAll('.content').forEach(section => section.classList.add('hidden'));
            const activePage = document.getElementById(id);
            if(activePage) activePage.classList.remove('hidden');

            closeExpandedCard();

            document.querySelectorAll('nav .nav-button').forEach(button => {
                const isTarget = button.dataset.target === id;
                button.classList.toggle('bg-blue-600', isTarget);
                button.classList.toggle('font-bold', isTarget);
                button.classList.toggle('shadow-inner', isTarget);
                button.classList.toggle('bg-transparent', !isTarget);
                button.classList.toggle('hover:bg-blue-500', !isTarget);
                button.classList.toggle('hover:translate-y-[-2px]', !isTarget);
            });

            const searchInput = document.getElementById(`searchBar${id.charAt(0).toUpperCase() + id.slice(1)}`);
            if (searchInput) searchInput.value = '';
        }

        /**
         * Ferme la carte actuellement √©tendue.
         */
        function closeExpandedCard() {
            if (expandedCard) {
                if(expandedCard.parentElement) {
                    if (expandedCard.dataset.type?.startsWith('new-')) {
                        // Si c'est une modale d'ajout, on la supprime compl√®tement
                        expandedCard.remove();
                    } else {
                        // Sinon, on la "r√©duit"
                        expandedCard.classList.remove('expanded-card', 'fixed', 'top-1/2', 'left-1/2', '-translate-x-1/2', '-translate-y-1/2', 'w-[95%]', 'max-w-5xl', 'h-auto', 'max-h-[90vh]', 'overflow-y-auto', 'p-8', 'shadow-2xl', 'z-[1000]', 'animate-expand', 'border-2', 'border-blue-600', 'rounded-xl');
                        const hiddenDetail = expandedCard.querySelector('.hidden-detail');
                        if (hiddenDetail) hiddenDetail.classList.add('hidden');
                        const closeButton = expandedCard.querySelector('.close-button');
                        if (closeButton) closeButton.remove();
                    }
                }
                expandedCard = null;
            }
            overlay.classList.add('hidden');
        }

        /**
         * Ouvre ou ferme une carte en vue d√©taill√©e.
         * @param {Event} event L'√©v√©nement de clic.
         * @param {HTMLElement} cardElement L'√©l√©ment de la carte.
         * @param {boolean} isReadOnly Si la carte est en lecture seule.
         */
        async function toggleCardExpansion(event, cardElement, isReadOnly = false) {
            if (event.target.closest('.actions button, [contenteditable="true"], textarea, input, .tag-item')) {
                return;
            }

            if (expandedCard) {
                closeExpandedCard();
                if (expandedCard === cardElement) return; // Si on clique sur la m√™me carte, on la ferme simplement.
            }

            expandedCard = cardElement;
            expandedCard.classList.add('expanded-card', 'fixed', 'top-1/2', 'left-1/2', '-translate-x-1/2', '-translate-y-1/2', 'w-[95%]', 'max-w-5xl', 'h-auto', 'max-h-[90vh]', 'overflow-y-auto', 'p-8', 'shadow-2xl', 'z-[1000]', 'animate-expand', 'border-2', 'border-blue-600', 'rounded-xl');
            
            const hiddenDetail = expandedCard.querySelector('.hidden-detail');
            hiddenDetail.classList.remove('hidden');
            overlay.classList.remove('hidden');

            const closeButton = document.createElement('span');
            closeButton.className = 'close-button absolute top-4 right-5 text-3xl font-bold text-gray-400 cursor-pointer z-[1001] p-2 rounded-full leading-none transition-all duration-300 ease-in-out bg-white bg-opacity-20 hover:text-gray-200 hover:bg-opacity-40 hover:scale-110';
            closeButton.innerHTML = '&times;';
            closeButton.onclick = (e) => { e.stopPropagation(); closeExpandedCard(); };
            expandedCard.appendChild(closeButton);

            if (!isReadOnly) {
                addCardEventListeners(expandedCard, expandedCard.dataset.type, expandedCard.dataset.id);
            } else {
                expandedCard.querySelectorAll('[contenteditable], textarea, input').forEach(el => {
                    el.setAttribute('readonly', 'true');
                    el.setAttribute('contenteditable', 'false');
                    el.classList.add('bg-gray-100', 'cursor-not-allowed');
                });
                expandedCard.querySelectorAll('.actions button:not(.print)').forEach(btn => btn.classList.add('hidden'));
            }
            expandedCard.querySelectorAll('textarea').forEach(autoResizeTextarea);
        }

        // ... Le reste des fonctions (CRUD, rendu, etc.) sera d√©fini ci-dessous ...
        
        // --- LOGIQUE D'AUTHENTIFICATION ---

        /**
         * G√®re les changements d'√©tat de l'authentification de l'utilisateur.
         */
        onAuthStateChanged(auth, async (user) => {
            const authModalCloseBtn = authModal.querySelector('.close-button');

            if (user) {
                // L'utilisateur est connect√©
                userId = user.uid;
                userIdDisplay.innerText = `Utilisateur: ${user.email || user.uid}`;
                authBtn.classList.add('hidden');
                signOutBtn.classList.remove('hidden');

                closeAuthModal();
                authModalCloseBtn.classList.remove('hidden'); // Bouton fermer visible si l'utilisateur est connect√©
                mainContent.classList.remove('hidden');
                nav.classList.remove('hidden');
                
                setupRealtimeListeners();
                showPage(currentPageId);
            } else {
                // L'utilisateur est d√©connect√©
                userId = null;
                userIdDisplay.innerText = 'Non connect√©';
                authBtn.classList.remove('hidden');
                signOutBtn.classList.add('hidden');

                mainContent.classList.add('hidden');
                nav.classList.add('hidden');
                document.querySelectorAll('.grid-container').forEach(container => container.innerHTML = '');
                
                detachRealtimeListeners(); // Important: d√©tache les anciens √©couteurs
                openAuthModal();
                authModalCloseBtn.classList.add('hidden'); // Masque le bouton fermer pour forcer la connexion
            }
        });

        function openAuthModal() {
            authModal.classList.remove('hidden');
            overlay.classList.remove('hidden');
        }

        function closeAuthModal() {
            authModal.classList.add('hidden');
            overlay.classList.add('hidden');
            emailInput.value = '';
            passwordInput.value = '';
        }

        /**
         * D√©tache tous les √©couteurs Firestore actifs.
         */
        function detachRealtimeListeners() {
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
        }


        // --- GESTION DES DONN√âES (FIRESTORE) ---

        /**
         * Cr√©e un √©couteur onSnapshot pour une collection donn√©e.
         * @param {string} collectionName Nom de la collection.
         * @param {Function} renderCallback Fonction √† appeler avec les donn√©es.
         * @param {boolean} isPublic Si la collection est publique.
         */
        function createSnapshotListener(collectionName, renderCallback, isPublic = false) {
            const path = isPublic
                ? `artifacts/${firebaseConfig.appId}/public/data/${collectionName}`
                : `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`;
            
            const q = query(collection(db, path));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCallback(data);
            }, (error) => {
                console.error(`Erreur d'√©coute de ${collectionName}:`, error);
                showModalMessage(`Erreur de chargement des donn√©es pour ${collectionName}.`, true);
            });

            unsubscribeListeners.push(unsubscribe); // Ajoute √† la liste pour le d√©tachement
        }

        /**
         * Met en place tous les √©couteurs en temps r√©el pour les collections de l'utilisateur.
         */
        function setupRealtimeListeners() {
            if (!userId) return;

            detachRealtimeListeners(); // S'assure qu'il n'y a pas d'anciens √©couteurs

            // √âcouteur pour les Objectifs
            createSnapshotListener(COLLECTIONS.OBJECTIFS, (data) => {
                renderEntries(COLLECTIONS.OBJECTIFS, 'objectifList', false, false, data);
            });

            // √âcouteur pour les Actions (qui met √† jour "TO DO" et "Termin√©es")
            createSnapshotListener(COLLECTIONS.ACTIONS, (data) => {
                renderEntries(COLLECTIONS.ACTIONS, 'actionList', true, false, data);
                renderEntries('actionsTerminees', 'actionTermineeList', true, true, data);
            });

            // √âcouteur pour les Notes de R√©union
            createSnapshotListener(COLLECTIONS.NOTES_REUNION, (data) => {
                renderEntries(COLLECTIONS.NOTES_REUNION, 'notesReunionList', false, false, data);
            });

            // √âcouteur pour les √âl√©ments Partag√©s (collection publique)
            createSnapshotListener(COLLECTIONS.SHARED_ENTRIES, (data) => {
                renderEntries(COLLECTIONS.SHARED_ENTRIES, 'sharedItemList', false, false, data, true);
            }, true);
        }
        
        // --- INITIALISATION ---

        /**
         * Met en place tous les gestionnaires d'√©v√©nements de la page.
         */
        function initializeEventListeners() {
            // Navigation principale
            document.querySelectorAll('nav .nav-button').forEach(button => {
                button.addEventListener('click', () => showPage(button.dataset.target));
            });
            
            // Boutons "Ajouter un nouvel √©l√©ment"
            document.querySelectorAll('.add-new-item-btn').forEach(button => {
                button.addEventListener('click', () => openNewItemModal(button.dataset.type));
            });

            // Barres de recherche (d√©clenchent un re-rendu)
            document.querySelectorAll('.searchBar').forEach(searchBar => {
                 searchBar.addEventListener('keyup', () => {
                    // Simule un re-rendu en appelant renderEntries avec un tableau vide
                    // La fonction piochera alors les donn√©es les plus r√©centes via onSnapshot
                    // et appliquera le filtre de recherche.
                    // C'est une simplification, une approche plus optimis√©e consisterait √† stocker
                    // les donn√©es localement et √† filtrer ce stock.
                     switch(searchBar.id) {
                         case 'searchBarObjectifs': setupRealtimeListeners(); break;
                         case 'searchBarActions': setupRealtimeListeners(); break;
                         case 'searchBarActionsTerminees': setupRealtimeListeners(); break;
                         case 'searchBarNotesReunion': setupRealtimeListeners(); break;
                         case 'searchBarSharedItems': setupRealtimeListeners(); break;
                     }
                 });
            });

            // Overlay (ferme les modales si l'utilisateur est connect√©)
            overlay.addEventListener('click', () => {
                if (auth.currentUser) {
                    closeExpandedCard();
                    closeAuthModal();
                }
            });

            // Modale d'authentification
            authBtn.addEventListener('click', openAuthModal);
            authModal.querySelector('.close-button').addEventListener('click', closeAuthModal);

            signInEmailBtn.addEventListener('click', async () => {
                try {
                    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                    showToastNotification('Connexion r√©ussie !', 'success');
                } catch (error) {
                    showModalMessage(`Erreur de connexion: ${error.message}`, true);
                }
            });

            signUpEmailBtn.addEventListener('click', async () => {
                try {
                    await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                    showToastNotification('Inscription r√©ussie et connect√© !', 'success');
                } catch (error) {
                    showModalMessage(`Erreur d'inscription: ${error.message}`, true);
                }
            });

            signInGoogleBtn.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, googleProvider);
                    showToastNotification('Connexion Google r√©ussie !', 'success');
                } catch (error) {
                    showModalMessage(`Erreur de connexion Google: ${error.message}`, true);
                }
            });
            
            // Bouton de d√©connexion
            signOutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showToastNotification('D√©connect√© avec succ√®s.', 'info');
                    // onAuthStateChanged g√©rera le reste
                } catch (error) {
                    showModalMessage(`Erreur lors de la d√©connexion: ${error.message}`, true);
                }
            });
        }
        
        // --- D√âMARRAGE DE L'APPLICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
            // L'√©tat de l'authentification est g√©r√© par onAuthStateChanged qui s'ex√©cute automatiquement.
            showPage('objectifs'); // Afficher la page par d√©faut au chargement
        });

        // NOTE: Les fonctions telles que renderEntries, addCardEventListeners, openNewItemModal,
        // deleteEntry, updateFieldFromCard etc. sont omises ici pour la bri√®vet√© car elles
        // sont identiques ou tr√®s similaires au code original que vous avez fourni.
        // Vous devez les copier/coller ici depuis votre code source original.
        // La structure ci-dessus montre comment les int√©grer dans un flux plus propre et robuste.
        // Si vous souhaitez que je les r√©√©crive √©galement, faites-le moi savoir.

    </script>
    </body>
</html>
