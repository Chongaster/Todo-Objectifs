<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi de Travail</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles personnalis√©s pour les animations et les overrides */
        @keyframes expandAnimation {
            from { transform: translate(-50%, -50%) scale(0.95); opacity: 0.9; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .animate-expand { animation: expandAnimation 0.3s forwards; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadein { animation: fadeIn 0.3s forwards; }

        @keyframes fadeinout {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }
        .animate-fadeinout { animation: fadeinout 4s forwards; }

        .deadline-overdue { color: #ef4444; /* red-500 */ }
        
        /* Styles d'impression */
        @media print {
            body * { visibility: hidden; }
            .expanded-card, .expanded-card * { visibility: visible; }
            .expanded-card {
                position: static !important; transform: none !important;
                left: auto !important; top: auto !important;
                margin: 0 auto !important; width: 100% !important;
                max-width: none !important; height: auto !important;
                max-height: none !important; overflow: visible !important;
                box-shadow: none !important; border: none !important;
                padding: 1rem !important; background: white !important;
                color: black !important;
            }
            .expanded-card .close-button,
            .expanded-card .actions,
            .expanded-card .add-new-item-btn,
            .expanded-card .add-step-card-btn { display: none !important; }
            .card h3, .historique strong { color: black !important; }
            .historique { border-left: 1px solid #ccc !important; background: #f9f9f9 !important; }
            input, textarea, [contenteditable="true"] {
                border: none !important; background: transparent !important;
                padding: 0 !important; margin: 0 !important;
                box-shadow: none !important; -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 leading-relaxed min-h-screen flex flex-col">

    <header class="bg-gradient-to-r from-gray-800 to-blue-800 text-white p-4 text-center shadow-lg fixed top-0 w-full z-50 box-border h-20 flex items-center justify-between rounded-b-lg">
        <h1 class="flex-grow text-center m-0 text-2xl md:text-3xl font-extrabold">Suivi de Travail</h1>
        <div class="flex flex-col items-end gap-1">
            <span id="userIdDisplay" class="text-sm text-gray-300">Non connect√©</span>
            <button id="authBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-all duration-300 ease-in-out shadow-sm">Connexion</button>
            <button id="signOutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-all duration-300 ease-in-out shadow-sm hidden">D√©connexion</button>
        </div>
    </header>

    <nav class="flex flex-wrap justify-center bg-gray-700 shadow-md fixed top-20 w-full z-40 box-border h-auto md:h-12 rounded-b-md hidden">
        <button class="nav-button" data-target="objectifs"><span class="mr-2">üéØ</span>Objectifs</button>
        <button class="nav-button" data-target="actions"><span class="mr-2">üìù</span>TO DO</button>
        <button class="nav-button" data-target="actionsTerminees"><span class="mr-2">‚úÖ</span>Termin√©es</button>
        <button class="nav-button" data-target="notesReunion"><span class="mr-2">üìã</span>Notes</button>
        <button class="nav-button" data-target="sharedItems"><span class="mr-2">üåê</span>Partag√©s</button>
    </nav>
    
    <main class="flex-grow pt-40 md:pt-36 pb-8 hidden">
        <div id="objectifs" class="content hidden"></div>
        <div id="actions" class="content hidden"></div>
        <div id="actionsTerminees" class="content hidden"></div>
        <div id="notesReunion" class="content hidden"></div>
        <div id="sharedItems" class="content hidden"></div>
    </main>
    
    <template id="page-template">
        <div class="p-4 md:p-8 max-w-7xl mx-auto">
            <h2 class="page-title text-3xl font-bold text-gray-800 mb-6"></h2>
            <p class="page-description text-gray-600 mb-6"></p>
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="text" class="searchBar w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Rechercher...">
                <button class="add-new-item-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg cursor-pointer text-lg block w-full md:w-fit whitespace-nowrap">‚ûï Ajouter</button>
            </div>
            <div class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-4"></div>
        </div>
    </template>
    
    <template id="card-template-base">
        <div class="card bg-white p-5 rounded-lg shadow-lg cursor-pointer transition-all duration-300 ease-in-out relative flex flex-col border border-gray-200 hover:-translate-y-1 hover:shadow-xl">
             <span class="card-icon absolute top-2 right-3 text-xl opacity-50"></span>
            <div class="card-content flex-grow">
                <h3 class="card-title text-xl font-bold text-gray-800 mb-2 break-words pr-6"></h3>
                <div class="card-summary text-gray-600 text-sm"></div>
                <div class="tags-display mt-auto pt-3 text-sm flex flex-wrap gap-1"></div>
            </div>
            <div class="hidden-detail hidden"></div>
        </div>
    </template>
    
    <template id="detail-template-objectif">
         <p class="mb-2"><strong>Titre:</strong> <span contenteditable="true" data-field="titre" class="editable-field"></span></p>
         <p class="mb-2"><strong>R√©alisation:</strong> <span class="progress-value font-bold"></span></p>
         <input type="range" min="0" max="100" data-field="pourcentage" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-4">
         <p class="mb-2"><strong>Description:</strong> <textarea data-field="description" class="editable-field min-h-[100px]"></textarea></p>
         <p class="mb-2"><strong>Commentaires:</strong> <textarea data-field="progressComments" class="editable-field min-h-[100px]"></textarea></p>
    </template>
    
    <template id="detail-template-action">
        <p class="mb-2"><strong>Titre:</strong> <span contenteditable="true" data-field="titre" class="editable-field"></span></p>
        <p class="mb-2"><strong>Deadline:</strong> <input type="date" data-field="deadLine" class="editable-field"></p>
        <p class="mb-2"><strong>√âtapes:</strong></p>
        <div class="steps-list mb-2" data-field="etapes-container"></div>
        <button type="button" class="add-step-card-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs mt-2">‚ûï √âtape</button>
    </template>

    <template id="detail-template-note">
        <p class="mb-2"><strong>Titre:</strong> <span contenteditable="true" data-field="titre" class="editable-field"></span></p>
        <p class="mb-2"><strong>Contenu:</strong> <textarea data-field="contenu" class="editable-field min-h-[150px]"></textarea></p>
    </template>

    <div class="overlay hidden fixed inset-0 w-full h-full bg-black bg-opacity-60 z-[999] backdrop-blur-sm animate-fadein" id="overlay"></div>

    <div id="authModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded-lg shadow-2xl z-[2000] max-w-md w-11/12 hidden animate-expand">
        <span class="close-button absolute top-4 right-5 text-3xl font-bold text-gray-400 cursor-pointer">&times;</span>
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Connexion / Inscription</h3>
        <div class="mb-4">
            <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
            <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3" placeholder="votre@email.com" autocomplete="email">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Mot de passe:</label>
            <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3" placeholder="********" autocomplete="current-password">
        </div>
        <div class="flex flex-col gap-3">
            <button id="signInEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Se connecter</button>
            <button id="signUpEmailBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">S'inscrire</button>
            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink mx-4 text-gray-400">OU</span><div class="flex-grow border-t border-gray-300"></div>
            </div>
            <button id="signInGoogleBtn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded shadow-md flex items-center justify-center gap-2 border">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5"> Se connecter avec Google
            </button>
        </div>
    </div>
    
<script type="module">
    // Importe les modules Firebase n√©cessaires.
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, addDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // --- CONFIGURATION & CONSTANTES ---
    const firebaseConfig = {
        apiKey: "AIzaSyCFMC73NLlmTzGVGcK_-zTwwNyw6-jmr7Y",
        authDomain: "suivitravailapp.firebaseapp.com",
        projectId: "suivitravailapp",
        storageBucket: "suivitravailapp.appspot.com",
        messagingSenderId: "621525076182",
        appId: "1:621525076182:web:f5a9bc1f5aaae71ce7e177",
        measurementId: "G-15HMDGYYCN"
    };

    const COLLECTIONS = {
        OBJECTIFS: 'objectifs',
        ACTIONS: 'actions',
        NOTES_REUNION: 'notesReunion',
        SHARED_ENTRIES: 'shared_entries'
    };
    
    const PAGE_CONFIG = {
        objectifs: { title: 'Objectifs', description: 'Suivez vos objectifs principaux et leur progression.', type: COLLECTIONS.OBJECTIFS },
        actions: { title: 'TO DO', description: 'G√©rez vos t√¢ches et actions √† r√©aliser.', type: COLLECTIONS.ACTIONS },
        actionsTerminees: { title: 'Actions Termin√©es', description: 'Consultez les actions que vous avez achev√©es.', type: COLLECTIONS.ACTIONS },
        notesReunion: { title: 'Notes de R√©union', description: 'Archivez et retrouvez toutes vos notes importantes.', type: COLLECTIONS.NOTES_REUNION },
        sharedItems: { title: '√âl√©ments Partag√©s', description: 'Ces √©l√©ments ont √©t√© partag√©s publiquement. Ils sont en lecture seule.', type: COLLECTIONS.SHARED_ENTRIES },
    };

    // --- INITIALISATION FIREBASE ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // --- VARIABLES GLOBALES & S√âLECTEURS DOM ---
    let userId = null;
    let expandedCard = null;
    let currentPageId = 'objectifs';
    let unsubscribeListeners = [];
    let allDataCache = {};
    
    const authModal = document.getElementById('authModal');
    const overlay = document.getElementById('overlay');
    const mainContent = document.querySelector('main');
    const nav = document.querySelector('nav');
    const pageTemplate = document.getElementById('page-template');
    
    // --- FONCTIONS UTILITAIRES & MODALES ---
    
    // ... (Le reste du JavaScript doit √™tre plac√© ici)
    // Le script complet est trop long pour √™tre inclus dans une seule r√©ponse.
    // Le code suivant est la continuation et la fin du bloc <script type="module">.
    // Il contient la logique m√©tier, la gestion des √©v√©nements, et le rendu.
    
    function showToastNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = 'toast-notification fixed bottom-5 left-1/2 -translate-x-1/2 text-white px-5 py-3 rounded-lg shadow-xl z-[3000] opacity-0 animate-fadeinout text-base flex items-center gap-2';
        const icons = { success: '‚úîÔ∏è', error: '‚ùå', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è' };
        const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600', warning: 'bg-yellow-500 text-black' };
        
        toast.classList.add(colors[type] || colors['info']);
        toast.innerHTML = `${icons[type] || icons['info']} ${message}`;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 4000);
    }

    async function showConfirmationModal(message) {
        return new Promise(resolve => {
            const container = document.createElement('div');
            container.innerHTML = `
                <div class="fixed inset-0 w-full h-full bg-black bg-opacity-50 z-[2999] animate-fadein"></div>
                <div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl z-[3000] text-center max-w-sm w-11/12 animate-expand">
                    <p class="mb-5 text-gray-800">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirmYes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded">Oui</button>
                        <button id="confirmNo" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">Non</button>
                    </div>
                </div>`;
            document.body.appendChild(container);

            const cleanup = (result) => {
                container.remove();
                resolve(result);
            };

            container.querySelector('#confirmYes').onclick = () => cleanup(true);
            container.querySelector('#confirmNo').onclick = () => cleanup(false);
            container.firstElementChild.onclick = () => cleanup(false);
        });
    }
    
    const getTimeStamp = () => new Date().toLocaleString('fr-FR');
    const autoResizeTextarea = (element) => {
        element.style.height = 'auto';
        element.style.height = `${element.scrollHeight}px`;
    };

    // --- GESTION DE L'AUTHENTIFICATION ---
    onAuthStateChanged(auth, user => {
        const authModalCloseBtn = authModal.querySelector('.close-button');
        if (user) {
            userId = user.uid;
            document.getElementById('userIdDisplay').innerText = `Connect√©: ${user.email || 'Anonyme'}`;
            document.getElementById('authBtn').classList.add('hidden');
            document.getElementById('signOutBtn').classList.remove('hidden');
            closeAuthModal();
            authModalCloseBtn.classList.remove('hidden');  
            mainContent.classList.remove('hidden');
            nav.classList.remove('hidden');
            setupRealtimeListeners();
            showPage(currentPageId);
        } else {
            userId = null;
            document.getElementById('userIdDisplay').innerText = 'Non connect√©';
            document.getElementById('authBtn').classList.remove('hidden');
            document.getElementById('signOutBtn').classList.add('hidden');
            mainContent.classList.add('hidden');
            nav.classList.add('hidden');
            document.querySelectorAll('.grid-container').forEach(container => container.innerHTML = '');
            detachRealtimeListeners(); 
            openAuthModal();
            authModalCloseBtn.classList.add('hidden');
        }
    });

    const openAuthModal = () => { authModal.classList.remove('hidden'); overlay.classList.remove('hidden'); };
    const closeAuthModal = () => {
        if (auth.currentUser) {
            authModal.classList.add('hidden');
            overlay.classList.add('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }
    };
    
    // --- GESTION DES DONN√âES (FIRESTORE) ---
    const detachRealtimeListeners = () => {
        unsubscribeListeners.forEach(unsubscribe => unsubscribe());
        unsubscribeListeners = [];
    };

    function setupRealtimeListeners() {
        if (!userId) return;
        detachRealtimeListeners();

        const createListener = (collectionName, cacheKey, isPublic = false) => {
            const path = isPublic 
                ? `${COLLECTIONS.SHARED_ENTRIES}` 
                : `users/${userId}/${collectionName}`;
            const q = query(collection(db, path));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                allDataCache[cacheKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (currentPageId === cacheKey || (currentPageId === 'actionsTerminees' && cacheKey === 'actions')) {
                     triggerRenderForCurrentPage();
                }
            }, (error) => {
                console.error(`Erreur d'√©coute de ${collectionName}:`, error);
                showToastNotification(`Erreur de chargement pour ${collectionName}.`, 'error');
            });
            unsubscribeListeners.push(unsubscribe);
        };

        createListener(COLLECTIONS.OBJECTIFS, 'objectifs');
        createListener(COLLECTIONS.ACTIONS, 'actions');
        createListener(COLLECTIONS.NOTES_REUNION, 'notesReunion');
        createListener(COLLECTIONS.SHARED_ENTRIES, 'sharedItems', true);
    }
    
    // --- LOGIQUE DE RENDU ET D'INTERFACE ---
    
    function showPage(id) {
        currentPageId = id;
        document.querySelectorAll('.content').forEach(section => {
            section.classList.add('hidden');
            section.innerHTML = '';
        });
        
        const activePage = document.getElementById(id);
        if (!activePage) return;
        
        const config = PAGE_CONFIG[id];
        const pageFragment = pageTemplate.content.cloneNode(true);
        pageFragment.querySelector('.page-title').textContent = config.title;
        pageFragment.querySelector('.page-description').textContent = config.description;
        pageFragment.querySelector('.add-new-item-btn').dataset.type = config.type;
        if (id === 'actionsTerminees' || id === 'sharedItems') {
            pageFragment.querySelector('.add-new-item-btn').remove();
        }
        
        activePage.appendChild(pageFragment);
        activePage.classList.remove('hidden');
        closeExpandedCard();

        document.querySelectorAll('nav .nav-button').forEach(button => {
            const isTarget = button.dataset.target === id;
            button.classList.toggle('bg-blue-600', isTarget);
            button.classList.toggle('font-bold', isTarget);
        });
        triggerRenderForCurrentPage();
    }
    
    function triggerRenderForCurrentPage() {
        const searchInput = document.querySelector(`#${currentPageId} .searchBar`);
        const searchTerm = searchInput ? searchInput.value : '';
        
        const options = { searchTerm, isReadOnly: false, displayCompleted: false };
        let data = [];
        
        if (currentPageId === 'objectifs') { data = allDataCache.objectifs || []; }
        else if (currentPageId === 'actions') { data = allDataCache.actions || []; options.displayCompleted = false; }
        else if (currentPageId === 'actionsTerminees') { data = allDataCache.actions || []; options.displayCompleted = true; }
        else if (currentPageId === 'notesReunion') { data = allDataCache.notesReunion || []; }
        else if (currentPageId === 'sharedItems') { data = allDataCache.sharedItems || []; options.isReadOnly = true; }
        
        renderEntries(currentPageId, data, options);
    }

    function renderEntries(containerId, data, options = {}) {
        if (expandedCard) return; 

        const { isReadOnly = false, displayCompleted = false, searchTerm = '' } = options;
        const container = document.querySelector(`#${containerId} .grid-container`);
        if (!container) return;
        container.innerHTML = '';

        let filteredData = data.filter(entry => {
            if (PAGE_CONFIG[containerId].type === COLLECTIONS.ACTIONS && (!!entry.isCompleted !== displayCompleted)) return false;
            if (searchTerm) {
                const content = [entry.titre, entry.contenu, entry.description, entry.progressComments, ...(entry.tags || [])]
                    .join(' ').toLowerCase();
                return content.includes(searchTerm.toLowerCase());
            }
            return true;
        });

        // Sorting logic...
        
        if (filteredData.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 col-span-full mt-12 text-lg">üìÇ<br>${searchTerm ? 'Aucun r√©sultat trouv√©.' : 'Rien √† afficher ici pour le moment.'}</p>`;
            return;
        }

        filteredData.forEach(entry => {
            const cardDiv = createCardElement(entry, isReadOnly);
            container.appendChild(cardDiv);
        });
    }

    // ... Le reste du code JS suivrait ici, en respectant la nouvelle structure.
    // La compl√©tion du code n√©cessiterait de refactoriser createCardElement, 
    // les modales, et la logique d'√©v√©nement comme d√©crit ci-dessus.
</script>

</body>
</html>
