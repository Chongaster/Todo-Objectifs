<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Klaro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script>
        // Configuration de Tailwind pour le mode sombre bas√© sur une classe
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* Appliquer une police plus moderne et lisible */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Am√©liorations de l'UI et animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-in-up { animation: slideInUp 0.4s ease-out forwards; }

        /* Styles pour le toast de notification */
        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        .animate-toast { animation: fadeinout 4s forwards; }

    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Conteneur principal de l'application -->
    <div id="app-container" class="flex flex-col h-screen">

        <!-- En-t√™te fixe -->
        <header class="bg-gray-800 dark:bg-gray-950 text-white shadow-md z-20">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-2xl md:text-3xl font-extrabold">Klaro</h1>
                <div class="flex items-center gap-3">
                    <span id="userIdDisplay" class="text-sm text-gray-300 hidden md:block">Non connect√©</span>
                    <button id="authBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Connexion</button>
                    <button id="preferencesBtn" class="hidden p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    <button id="signOutBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">D√©connexion</button>
                </div>
            </div>
            <div id="modeSelector" class="bg-gray-700 dark:bg-gray-800 flex justify-center gap-2 p-2 hidden">
                <button data-mode="pro" class="px-5 py-2 text-base font-bold rounded-lg transition-all duration-200">üè¢ Pro</button>
                <button data-mode="perso" class="px-5 py-2 text-base font-bold rounded-lg transition-all duration-200">üè† Perso</button>
            </div>
            <nav id="main-nav" class="bg-white/10 flex flex-wrap justify-center p-1 hidden">
                <!-- Les boutons de navigation seront ins√©r√©s ici par JS -->
            </nav>
        </header>

        <!-- Contenu principal scrollable -->
        <main class="flex-grow overflow-y-auto p-4 md:p-6">
            <div id="page-content" class="container mx-auto">
                <!-- Le contenu de la page sera inject√© ici -->
            </div>
        </main>
    </div>

    <!-- Modale (conteneur universel) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 flex items-center justify-center p-4 hidden animate-fade-in">
        <div id="modal-container" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-h-[90vh] flex flex-col animate-slide-in-up">
            <!-- Le contenu de la modale sera inject√© ici -->
        </div>
    </div>

    <!-- Template pour une page -->
    <template id="page-template">
        <div class="animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 class="page-title text-3xl font-bold text-gray-900 dark:text-gray-100"></h2>
                    <p class="page-description text-gray-600 dark:text-gray-400 mt-1"></p>
                </div>
                <button class="add-new-item-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg cursor-pointer text-lg w-full md:w-auto whitespace-nowrap shadow-md transition-transform hover:scale-105">‚ûï Ajouter</button>
            </div>
            <input type="text" class="searchBar w-full p-3 mb-6 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" placeholder="Rechercher...">
            <div class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
    </template>

    <!-- Template pour une carte -->
    <template id="card-template">
        <div class="card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg cursor-pointer transition-all duration-300 relative flex flex-col border border-gray-200 dark:border-gray-700 hover:-translate-y-1 hover:shadow-xl dark:hover:shadow-blue-500/20">
            <span class="card-icon absolute top-4 right-4 text-2xl opacity-40"></span>
            <div class="flex-grow flex flex-col">
                <h3 class="card-title text-xl font-bold text-gray-800 dark:text-gray-100 mb-2 break-words pr-8"></h3>
                <div class="card-summary text-gray-600 dark:text-gray-400 text-sm flex-grow"></div>
                <div class="tags-display mt-auto pt-3 text-sm flex flex-wrap gap-2"></div>
            </div>
        </div>
    </template>

<script type="module">
    // Importe les modules Firebase n√©cessaires.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- CONFIGURATION & CONSTANTES ---
    const firebaseConfig = {
        apiKey: "AIzaSyCFMC73NLlmTzGVGcK_-zTwwNyw6-jmr7Y",
        authDomain: "suivitravailapp.firebaseapp.com",
        projectId: "suivitravailapp",
        storageBucket: "suivitravailapp.appspot.com",
        messagingSenderId: "621525076182",
        appId: "1:621525076182:web:f5a9bc1f5aaae71ce7e177",
        measurementId: "G-15HMDGYYCN"
    };
    const appId = firebaseConfig.appId;

    const COLLECTIONS = {
        OBJECTIFS: 'objectifs',
        ACTIONS: 'actions',
        NOTES_REUNION: 'notesReunion',
        SHARED_ENTRIES: 'shared_entries',
        TODO: 'todo_perso',
        VOYAGES: 'voyages',
        NOTES_PERSO: 'notes_perso',
        COURSES: 'courses',
        USER_PREFERENCES: 'user_preferences'
    };

    const NAV_CONFIG = {
        pro: [
            { id: 'objectifs', title: 'Objectifs', icon: 'üéØ', type: COLLECTIONS.OBJECTIFS, description: 'Suivez vos objectifs principaux et leur progression.' },
            { id: 'actions', title: 'TO DO', icon: 'üìù', type: COLLECTIONS.ACTIONS, description: 'G√©rez vos t√¢ches et actions √† r√©aliser.' },
            { id: 'actionsTerminees', title: 'Termin√©es', icon: '‚úÖ', type: COLLECTIONS.ACTIONS, description: 'Consultez les actions que vous avez achev√©es.' },
            { id: 'notesReunion', title: 'Notes', icon: 'üìã', type: COLLECTIONS.NOTES_REUNION, description: 'Archivez et retrouvez toutes vos notes.' },
            { id: 'sharedItems', title: 'Partag√©s', icon: 'üåê', type: COLLECTIONS.SHARED_ENTRIES, description: 'Ces √©l√©ments ont √©t√© partag√©s publiquement. Ils sont en lecture seule.' }
        ],
        perso: [
            { id: 'todo_perso', title: 'TODO', icon: 'üìå', type: COLLECTIONS.TODO, description: 'Vos t√¢ches personnelles.' },
            { id: 'voyages', title: 'Voyages', icon: '‚úàÔ∏è', type: COLLECTIONS.VOYAGES, description: 'Planifiez vos prochaines escapades.' },
            { id: 'notes_perso', title: 'Notes', icon: 'üóíÔ∏è', type: COLLECTIONS.NOTES_PERSO, description: 'Vos pens√©es et m√©mos personnels.' },
            { id: 'courses', title: 'Courses', icon: 'üõí', type: COLLECTIONS.COURSES, description: 'N\'oubliez plus rien au supermarch√©.' }
        ]
    };

    // --- INITIALISATION FIREBASE ---
    let app, db, auth;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
    } catch (e) {
        console.error("Erreur d'initialisation de Firebase:", e);
        document.body.innerHTML = `<div class="p-8 text-center text-red-500">Erreur critique de configuration Firebase. L'application ne peut pas d√©marrer.</div>`;
    }
    
    const googleProvider = new GoogleAuthProvider();

    // --- VARIABLES GLOBALES & S√âLECTEURS DOM ---
    let userId = null;
    let userPreferences = { theme: 'light', startupMode: 'perso' };
    let currentMode = userPreferences.startupMode;
    let currentPageId = NAV_CONFIG[currentMode][0].id;
    let unsubscribeListeners = [];
    let allDataCache = {};

    const modalOverlay = document.getElementById('modal-overlay');
    const modalContainer = document.getElementById('modal-container');
    const pageContent = document.getElementById('page-content');
    const mainNav = document.getElementById('main-nav');
    const modeSelector = document.getElementById('modeSelector');

    // --- FONCTIONS UTILITAIRES & MODALES ---
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-5 right-5 text-white px-5 py-3 rounded-lg shadow-xl z-50 animate-toast text-base flex items-center gap-2';
        const icons = { success: '‚úîÔ∏è', error: '‚ùå', info: '‚ÑπÔ∏è' };
        const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
        
        toast.classList.add(colors[type] || colors.info);
        toast.innerHTML = `${icons[type] || icons.info} ${message}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function showModal(content, maxWidthClass = 'max-w-xl') {
        modalContainer.innerHTML = content;
        modalContainer.className = `bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full ${maxWidthClass} max-h-[90vh] flex flex-col animate-slide-in-up`;
        modalOverlay.classList.remove('hidden');
        modalContainer.querySelector('.modal-close-btn')?.addEventListener('click', hideModal);
    }

    function hideModal() {
        modalOverlay.classList.add('hidden');
        modalContainer.innerHTML = '';
    }

    async function showConfirmationModal(message) {
        return new Promise(resolve => {
            const content = `
                <div class="p-6 text-center">
                    <p class="mb-6 text-lg text-gray-800 dark:text-gray-200">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Oui, supprimer</button>
                        <button id="confirm-no" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Annuler</button>
                    </div>
                </div>
            `;
            showModal(content, 'max-w-sm');
            document.getElementById('confirm-yes').onclick = () => { hideModal(); resolve(true); };
            document.getElementById('confirm-no').onclick = () => { hideModal(); resolve(false); };
        });
    }

    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    const getTimeStamp = () => new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'medium' });

    // --- GESTION DES PR√âF√âRENCES ---
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        userPreferences.theme = theme;
    }

    async function saveUserPreferences(prefs) {
        if (!userId) return;
        const prefRef = doc(db, `artifacts/${appId}/users/${userId}/${COLLECTIONS.USER_PREFERENCES}`, 'settings');
        try {
            await setDoc(prefRef, prefs, { merge: true });
        } catch (error) {
            console.error("Erreur de sauvegarde des pr√©f√©rences:", error);
        }
    }

    async function loadUserPreferences() {
        if (!userId) return userPreferences; // Retourne les pr√©f√©rences par d√©faut
        const prefRef = doc(db, `artifacts/${appId}/users/${userId}/${COLLECTIONS.USER_PREFERENCES}`, 'settings');
        try {
            const docSnap = await getDoc(prefRef);
            if (docSnap.exists()) {
                return { ...userPreferences, ...docSnap.data() };
            }
            return userPreferences;
        } catch (error) {
            console.error("Erreur de chargement des pr√©f√©rences:", error);
            return userPreferences;
        }
    }

    function showPreferencesModal() {
        const content = `
            <div class="flex-shrink-0 p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Pr√©f√©rences</h3>
                <button class="modal-close-btn text-3xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-lg font-medium mb-2">Th√®me d'affichage</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 p-3 border dark:border-gray-600 rounded-lg cursor-pointer">
                            <input type="radio" name="theme" value="light" ${userPreferences.theme === 'light' ? 'checked' : ''}>
                            ‚òÄÔ∏è Clair
                        </label>
                        <label class="flex items-center gap-2 p-3 border dark:border-gray-600 rounded-lg cursor-pointer">
                            <input type="radio" name="theme" value="dark" ${userPreferences.theme === 'dark' ? 'checked' : ''}>
                            üåô Sombre
                        </label>
                    </div>
                </div>
                 <div>
                    <label class="block text-lg font-medium mb-2">Mode de d√©marrage par d√©faut</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 p-3 border dark:border-gray-600 rounded-lg cursor-pointer">
                            <input type="radio" name="startupMode" value="pro" ${userPreferences.startupMode === 'pro' ? 'checked' : ''}>
                            üè¢ Pro
                        </label>
                        <label class="flex items-center gap-2 p-3 border dark:border-gray-600 rounded-lg cursor-pointer">
                            <input type="radio" name="startupMode" value="perso" ${userPreferences.startupMode === 'perso' ? 'checked' : ''}>
                            üè† Perso
                        </label>
                    </div>
                </div>
            </div>
        `;
        showModal(content, 'max-w-md');
        
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                applyTheme(e.target.value);
                saveUserPreferences({ theme: e.target.value });
            });
        });
        document.querySelectorAll('input[name="startupMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                userPreferences.startupMode = e.target.value;
                saveUserPreferences({ startupMode: e.target.value });
            });
        });
    }

    // --- GESTION DE L'AUTHENTIFICATION ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            userPreferences = await loadUserPreferences();
            
            applyTheme(userPreferences.theme);
            currentMode = userPreferences.startupMode;
            currentPageId = NAV_CONFIG[currentMode][0].id;

            document.getElementById('userIdDisplay').textContent = user.isAnonymous ? 'Mode Invit√©' : (user.email || 'Connect√©');
            document.getElementById('authBtn').classList.add('hidden');
            document.getElementById('preferencesBtn').classList.remove('hidden');
            document.getElementById('signOutBtn').classList.remove('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
            document.getElementById('main-nav').classList.remove('hidden');
            
            hideModal();
            setupRealtimeListeners();
            setMode(currentMode);
        } else {
            userId = null;
            applyTheme('light'); // Revenir au th√®me clair par d√©faut
            document.getElementById('userIdDisplay').textContent = 'Non connect√©';
            document.getElementById('authBtn').classList.remove('hidden');
            document.getElementById('preferencesBtn').classList.add('hidden');
            document.getElementById('signOutBtn').classList.add('hidden');
            document.getElementById('modeSelector').classList.add('hidden');
            document.getElementById('main-nav').classList.add('hidden');
            pageContent.innerHTML = '';
            detachRealtimeListeners();
            showAuthModal();
        }
    });

    function showAuthModal() {
        const content = `
            <div class="p-6 md:p-8 relative">
                <button class="modal-close-btn absolute top-4 right-5 text-3xl font-bold text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">&times;</button>
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center">Connexion / Inscription</h3>
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Email :</label>
                        <input type="email" id="email" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" placeholder="votre@email.com" autocomplete="email">
                    </div>
                    <div>
                        <label for="password" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Mot de passe :</label>
                        <input type="password" id="password" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" placeholder="********" autocomplete="current-password">
                    </div>
                    <div class="flex flex-col gap-3 pt-2">
                        <button id="signInEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Se connecter</button>
                        <button id="signUpEmailBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">S'inscrire</button>
                    </div>
                    <div class="relative flex py-4 items-center">
                        <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div><span class="flex-shrink mx-4 text-gray-400 dark:text-gray-500">OU</span><div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    </div>
                     <button id="signInGoogleBtn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-md flex items-center justify-center gap-3 border border-gray-300 dark:border-gray-600 w-full">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5"> Se connecter avec Google
                    </button>
                </div>
            </div>
        `;
        showModal(content);
        document.getElementById('signInEmailBtn').addEventListener('click', handleEmailSignIn);
        document.getElementById('signUpEmailBtn').addEventListener('click', handleEmailSignUp);
        document.getElementById('signInGoogleBtn').addEventListener('click', handleGoogleSignIn);
    }
    
    async function handleEmailSignIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try { await signInWithEmailAndPassword(auth, email, password); showToast('Connexion r√©ussie !', 'success'); } 
        catch (error) { showToast(`Erreur: ${error.code}`, 'error'); }
    }
    async function handleEmailSignUp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try { await createUserWithEmailAndPassword(auth, email, password); showToast('Inscription r√©ussie !', 'success'); } 
        catch (error) { showToast(`Erreur: ${error.code}`, 'error'); }
    }
    async function handleGoogleSignIn() {
        try { await signInWithPopup(auth, googleProvider); showToast('Connexion Google r√©ussie !', 'success'); } 
        catch (error) { showToast(`Erreur: ${error.code}`, 'error'); }
    }

    // --- GESTION DES DONN√âES (FIRESTORE) ---
    function detachRealtimeListeners() {
        unsubscribeListeners.forEach(unsubscribe => unsubscribe());
        unsubscribeListeners = [];
    }

    function setupRealtimeListeners() {
        if (!userId) return;
        detachRealtimeListeners();

        const allCollections = [...new Set(Object.values(NAV_CONFIG).flat().map(c => c.type))];

        allCollections.forEach(collectionName => {
            const isPublic = collectionName === COLLECTIONS.SHARED_ENTRIES;
            const path = isPublic 
                ? `artifacts/${appId}/public/data/${collectionName}`
                : `artifacts/${appId}/users/${userId}/${collectionName}`;
            
            const q = query(collection(db, path));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                allDataCache[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const currentPageConfig = NAV_CONFIG[currentMode].find(p => p.id === currentPageId);
                if (currentPageConfig && currentPageConfig.type === collectionName) {
                    renderCurrentPageContent();
                }
            }, (error) => {
                console.error(`Erreur d'√©coute sur ${collectionName}:`, error);
            });
            unsubscribeListeners.push(unsubscribe);
        });
    }

    // --- LOGIQUE DE RENDU ET D'INTERFACE ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('#modeSelector button').forEach(btn => {
            const isActive = btn.dataset.mode === mode;
            btn.classList.toggle('bg-white', isActive);
            btn.classList.toggle('dark:bg-gray-300', isActive);
            btn.classList.toggle('text-blue-700', isActive);
            btn.classList.toggle('dark:text-gray-900', isActive);
            btn.classList.toggle('text-white', !isActive);
        });
        
        const navItems = NAV_CONFIG[mode];
        mainNav.innerHTML = navItems.map(item => `
            <button class="nav-button text-white/80 hover:text-white hover:bg-white/20 px-3 py-2 rounded-md text-sm font-medium transition-colors" data-target="${item.id}">
                <span class="mr-1">${item.icon}</span>${item.title}
            </button>
        `).join('');
        
        showPage(navItems[0].id);
    }

    function showPage(id) {
        currentPageId = id;
        
        mainNav.querySelectorAll('.nav-button').forEach(button => {
            const isActive = button.dataset.target === id;
            button.classList.toggle('bg-white/20', isActive);
            button.classList.toggle('dark:bg-gray-300/20', isActive);
            button.classList.toggle('font-bold', isActive);
        });

        const config = NAV_CONFIG[currentMode].find(p => p.id === id);
        if (!config) return;

        const pageFragment = document.getElementById('page-template').content.cloneNode(true);
        pageFragment.querySelector('.page-title').textContent = config.title;
        pageFragment.querySelector('.page-description').textContent = config.description;
        pageFragment.querySelector('.searchBar').dataset.page = id;

        const addButton = pageFragment.querySelector('.add-new-item-btn');
        if (id === 'actionsTerminees' || id === 'sharedItems') {
            addButton.remove();
        } else {
            addButton.onclick = () => showItemModal(null, config.type);
        }

        pageContent.innerHTML = '';
        pageContent.appendChild(pageFragment);

        renderCurrentPageContent();
    }

    function renderCurrentPageContent() {
        const container = pageContent.querySelector('.grid-container');
        if (!container) return;

        const searchTerm = (pageContent.querySelector('.searchBar')?.value || '').toLowerCase();
        const config = NAV_CONFIG[currentMode].find(p => p.id === currentPageId);
        if (!config) return;

        let data = allDataCache[config.type] || [];
        
        if (config.id === 'actionsTerminees') {
            data = data.filter(entry => entry.isCompleted);
        } else if (config.type === COLLECTIONS.ACTIONS || config.type === COLLECTIONS.TODO) {
            data = data.filter(entry => !entry.isCompleted);
        }

        if (searchTerm) {
            data = data.filter(entry => JSON.stringify(entry).toLowerCase().includes(searchTerm));
        }
        
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 col-span-full mt-12 text-lg">üìÇ<br>${searchTerm ? 'Aucun r√©sultat trouv√©.' : 'Rien √† afficher ici.'}</p>`;
            return;
        }

        data.forEach(entry => {
            const cardEl = createCardElement(entry, config);
            container.appendChild(cardEl);
        });
    }

    function createCardElement(entry, pageConfig) {
        const cardTemplate = document.getElementById('card-template').content.cloneNode(true);
        const card = cardTemplate.firstElementChild;
        const isReadOnly = pageConfig.id === 'sharedItems';
        const originalType = isReadOnly ? entry.originalCollection : pageConfig.type;
        
        card.dataset.id = entry.id;
        card.dataset.type = originalType;
        card.onclick = () => showItemModal(entry, originalType);

        card.querySelector('.card-title').textContent = entry.titre || 'Sans titre';
        card.querySelector('.card-icon').textContent = NAV_CONFIG[currentMode].find(p => p.id === pageConfig.id)?.icon || '‚ùì';
        
        const summaryEl = card.querySelector('.card-summary');
        if (originalType === COLLECTIONS.OBJECTIFS) {
            const pct = entry.pourcentage || 0;
            const progressClass = pct < 25 ? 'bg-red-500' : (pct < 75 ? 'bg-yellow-500' : 'bg-green-500');
            summaryEl.innerHTML = `<div class="bg-gray-200 dark:bg-gray-700 rounded-full h-5 my-2 shadow-inner"><div class="h-full text-center text-white font-bold text-xs leading-5 transition-all duration-500 ${progressClass}" style="width: ${pct}%">${pct}%</div></div>`;
        } else if (originalType === COLLECTIONS.ACTIONS && entry.deadLine) {
            summaryEl.innerHTML = `<span>Deadline: <strong class="${new Date() > new Date(entry.deadLine) && !entry.isCompleted ? 'text-red-500 font-semibold' : ''}">${new Date(entry.deadLine).toLocaleDateString('fr-FR')}</strong></span>`;
        } else if (originalType === COLLECTIONS.COURSES) {
             const items = entry.items || [];
             const completedItems = items.filter(item => item.completed).length;
             summaryEl.textContent = `${completedItems} / ${items.length} articles coch√©s`;
        } else if (entry.contenu) {
            summaryEl.textContent = `${entry.contenu.substring(0, 100)}...`;
        }

        const tagsContainer = card.querySelector('.tags-display');
        (entry.tags || []).forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 px-2 py-1 rounded-full text-xs font-semibold';
            tagEl.textContent = tag;
            tagsContainer.appendChild(tagEl);
        });

        return card;
    }

    // --- LOGIQUE DE LA MODALE D'√âDITION/CR√âATION ---
    function showItemModal(entry, type) {
        const isNew = !entry;
        const isReadOnly = currentPageId === 'sharedItems';
        const data = isNew ? { titre: '', contenu: '', tags: [] } : entry;

        let formHtml = '';
        formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Titre</label><input type="text" data-field="titre" value="${data.titre}" placeholder="Titre de l'√©l√©ment" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></div>`;
        
        if (type === COLLECTIONS.OBJECTIFS) {
            formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Description</label><textarea data-field="description" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">${data.description || ''}</textarea></div>`;
            formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Pourcentage: <span id="pct-label" class="font-bold">${data.pourcentage || 0}%</span></label><input type="range" data-field="pourcentage" min="0" max="100" value="${data.pourcentage || 0}" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer"></div>`;
        } else if (type === COLLECTIONS.ACTIONS) {
            formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Contenu / Description</label><textarea data-field="contenu" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">${data.contenu || ''}</textarea></div>`;
            formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Deadline</label><input type="date" data-field="deadLine" value="${data.deadLine || ''}" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></div>`;
        } else if (type === COLLECTIONS.COURSES) {
            formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Articles</label><div id="course-items-list" class="mt-2 space-y-2"></div></div>`;
            formHtml += `<div class="flex gap-2"><input type="text" id="new-course-item-input" placeholder="Nouvel article" class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"><button type="button" id="add-course-item-btn" class="bg-blue-500 text-white px-4 rounded-lg">Ajouter</button></div>`;
        } else { 
             formHtml += `<div class="mb-4 flex-grow flex flex-col"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Contenu</label><textarea data-field="contenu" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 flex-grow">${data.contenu || ''}</textarea></div>`;
        }

        if (type !== COLLECTIONS.COURSES) {
            formHtml += `<div class="mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Tags (s√©par√©s par des virgules)</label><input type="text" data-field="tags" value="${(data.tags || []).join(', ')}" class="w-full p-3 mt-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></div>`;
        }

        let historyHtml = '';
        if (!isNew && data.historique) {
            historyHtml = `<div class="historique text-xs text-gray-500 dark:text-gray-400 mt-6 bg-gray-100 dark:bg-gray-900/50 p-3 border dark:border-gray-700 rounded-md max-h-24 overflow-y-auto"><strong>Historique :</strong><ul class="list-none pl-0 mt-1">${data.historique.slice().reverse().map(line => `<li>‚Ä¢ ${line}</li>`).join('')}</ul></div>`;
        }

        let actionsHtml = '<div class="modal-actions flex flex-wrap gap-3 justify-end">';
        if (!isReadOnly) {
            if (isNew) {
                actionsHtml += `<button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">üíæ Enregistrer</button>`;
            } else {
                 if ([COLLECTIONS.ACTIONS, COLLECTIONS.TODO].includes(type)) {
                    if (data.isCompleted) {
                        actionsHtml += `<button data-action="toggleComplete" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">‚Ü©Ô∏è R√©-ouvrir</button>`;
                    } else {
                        actionsHtml += `<button data-action="toggleComplete" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">‚úÖ Terminer</button>`;
                    }
                }
                if (currentMode === 'pro') {
                    actionsHtml += `<button data-action="share" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">üîó Partager</button>`;
                }
                actionsHtml += `<button data-action="delete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">üóëÔ∏è Supprimer</button>`;
            }
        }
        actionsHtml += '</div>';

        const modalTitle = isNew ? `Ajouter un √©l√©ment` : `Modifier: ${data.titre}`;
        const finalContent = `
            <div class="flex-shrink-0 p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">${modalTitle}</h3>
                <button class="modal-close-btn text-3xl font-bold text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">&times;</button>
            </div>
            <div class="p-4 flex-grow overflow-y-auto flex flex-col" id="modal-form-content">
                ${formHtml}
                ${historyHtml}
            </div>
            <div class="flex-shrink-0 p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                ${actionsHtml}
            </div>
        `;

        const maxWidth = [COLLECTIONS.NOTES_REUNION, COLLECTIONS.NOTES_PERSO, COLLECTIONS.VOYAGES].includes(type) ? 'max-w-4xl' : 'max-w-2xl';
        showModal(finalContent, maxWidth);
        
        if (type === COLLECTIONS.COURSES) {
            renderCourseItems(data.items || [], isNew ? null : entry.id);
        }
        if (isReadOnly) {
            modalContainer.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
        }

        attachModalListeners(entry, type);
    }

    function attachModalListeners(entry, type) {
        const isNew = !entry;
        
        const rangeInput = modalContainer.querySelector('input[type="range"]');
        if(rangeInput) {
            rangeInput.addEventListener('input', (e) => {
                document.getElementById('pct-label').textContent = `${e.target.value}%`;
            });
        }

        if (isNew) {
            document.getElementById('save-btn').onclick = () => saveEntry(null, type);
        } else {
            const deleteBtn = modalContainer.querySelector('[data-action="delete"]');
            if(deleteBtn) deleteBtn.onclick = () => deleteEntry(type, entry.id);
            
            const shareBtn = modalContainer.querySelector('[data-action="share"]');
            if(shareBtn) shareBtn.onclick = () => shareEntry(type, entry.id);

            const toggleCompleteBtn = modalContainer.querySelector('[data-action="toggleComplete"]');
            if(toggleCompleteBtn) toggleCompleteBtn.onclick = () => markAsCompleted(type, entry.id, !entry.isCompleted);
        }

        if (type === COLLECTIONS.COURSES && entry) {
            const addBtn = document.getElementById('add-course-item-btn');
            const addInput = document.getElementById('new-course-item-input');
            addBtn.onclick = () => addOrUpdateCourseItem(entry.id);
            addInput.onkeydown = (e) => { if(e.key === 'Enter') { e.preventDefault(); addOrUpdateCourseItem(entry.id); }};
        }

        modalContainer.querySelectorAll('[data-field]').forEach(input => {
            if (input.tagName.toLowerCase() === 'textarea') {
                input.style.overflowY = 'hidden';
                autoResizeTextarea(input);
                input.addEventListener('input', () => autoResizeTextarea(input));
            }

            if (!isNew) {
                input.addEventListener('blur', (e) => {
                    handleUpdate(type, entry.id, e.target.dataset.field, e.target.value);
                });
            }
        });
        
        if (!isNew && rangeInput) {
            rangeInput.addEventListener('change', (e) => {
                handleUpdate(type, entry.id, e.target.dataset.field, e.target.value);
            });
        }
    }

    // --- CRUD OPERATIONS ---
    async function saveEntry(id, collectionName) {
        const isNew = !id;
        const form = document.getElementById('modal-form-content');
        const titreInput = form.querySelector('[data-field="titre"]');

        if (!titreInput || !titreInput.value.trim()) {
            showToast("Le titre est obligatoire.", "error");
            return;
        }

        let newEntryData = {};
        form.querySelectorAll('[data-field]').forEach(input => {
            const field = input.dataset.field;
            let value = input.value;
            if (field === 'tags') value = value.split(',').map(t => t.trim()).filter(Boolean);
            if (input.type === 'range') value = parseInt(value, 10);
            newEntryData[field] = value;
        });

        if (isNew) {
            newEntryData.historique = [`Cr√©√© le ${getTimeStamp()}`];
            newEntryData.createdAt = new Date().toISOString();
            if (collectionName === COLLECTIONS.ACTIONS || collectionName === COLLECTIONS.TODO) {
                newEntryData.isCompleted = false;
            }
            if (collectionName === COLLECTIONS.COURSES) {
                newEntryData.items = []; 
            }
        }

        try {
            const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
            if (isNew) {
                await addDoc(collection(db, path), newEntryData);
                showToast("√âl√©ment ajout√© !", 'success');
            }
            hideModal();
        } catch (error) {
            console.error("Erreur d'enregistrement:", error);
            showToast("Erreur lors de l'enregistrement.", "error");
        }
    }

    async function handleUpdate(collectionName, id, field, value) {
        if (!userId) return;
        const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
        const docRef = doc(db, path, id);
        try {
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return;

            let updateValue = value;
            if (field === 'tags') updateValue = value.split(',').map(t => t.trim()).filter(Boolean);
            if (field === 'pourcentage') updateValue = parseInt(value, 10);

            const newHistoryEntry = `Champ '${field}' mis √† jour le ${getTimeStamp()}`;
            const updates = {
                [field]: updateValue,
                historique: [...(docSnap.data().historique || []), newHistoryEntry]
            };
            await updateDoc(docRef, updates);
            showToast("Mise √† jour enregistr√©e.", 'success');
        } catch (error) {
            console.error("Erreur de mise √† jour:", error);
            showToast("Erreur de mise √† jour.", "error");
        }
    }
    
    async function deleteEntry(collectionName, id) {
        const confirmed = await showConfirmationModal("Supprimer cet √©l√©ment d√©finitivement ?");
        if (confirmed) {
            const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
            try {
                await deleteDoc(doc(db, path, id));
                showToast("√âl√©ment supprim√©.", 'success');
                hideModal();
            } catch (error) {
                showToast("Erreur de suppression.", "error");
            }
        }
    }

    async function markAsCompleted(collectionName, id, isCompleted) {
        const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
        const docRef = doc(db, path, id);
        try {
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return;
            const newHistoryEntry = `Marqu√© comme ${isCompleted ? 'termin√©' : 'non termin√©'} le ${getTimeStamp()}`;
            await updateDoc(docRef, {
                isCompleted,
                historique: [...(docSnap.data().historique || []), newHistoryEntry]
            });
            showToast(`Action mise √† jour.`, 'success');
            hideModal();
        } catch (error) {
            showToast("Erreur de mise √† jour.", "error");
        }
    }
    
    async function shareEntry(collectionName, id) {
        const publicDocPath = `artifacts/${appId}/public/data/${COLLECTIONS.SHARED_ENTRIES}`;
        const userDocPath = `artifacts/${appId}/users/${userId}/${collectionName}/${id}`;
        try {
            const docSnap = await getDoc(doc(db, userDocPath));
            if (docSnap.exists()) {
                const dataToShare = {
                    ...docSnap.data(),
                    originalCollection: collectionName,
                    originalUserId: userId,
                    sharedAt: getTimeStamp()
                };
                await addDoc(collection(db, publicDocPath), dataToShare);
                showToast("√âl√©ment partag√© avec succ√®s !", 'success');
            }
        } catch (error) {
            showToast("Erreur lors du partage.", "error");
        }
    }

    // --- LOGIQUE SP√âCIFIQUE LISTE DE COURSES ---
    function renderCourseItems(items, docId) {
        const container = document.getElementById('course-items-list');
        if (!container) return;
        container.innerHTML = (items || []).map((item, index) => `
            <div class="flex items-center justify-between p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" data-item-index="${index}" ${item.completed ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 bg-transparent">
                    <span class="ml-3 text-gray-700 dark:text-gray-300 ${item.completed ? 'line-through text-gray-400 dark:text-gray-500' : ''}">${item.text}</span>
                </label>
                <button data-action="delete-course-item" data-item-index="${index}" class="text-gray-400 hover:text-red-500 text-xl">üóëÔ∏è</button>
            </div>
        `).join('');

        if(docId) {
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.onchange = (e) => addOrUpdateCourseItem(docId, parseInt(e.target.dataset.itemIndex), e.target.checked);
            });
            container.querySelectorAll('[data-action="delete-course-item"]').forEach(btn => {
                btn.onclick = (e) => addOrUpdateCourseItem(docId, parseInt(e.currentTarget.dataset.itemIndex), null, true);
            });
        }
    }

    async function addOrUpdateCourseItem(docId, indexToUpdate = null, isCompleted = null, toDelete = false) {
        if (!docId) {
            showToast("Veuillez d'abord enregistrer la nouvelle liste.", "info");
            return;
        }

        const docRef = doc(db, `artifacts/${appId}/users/${userId}/${COLLECTIONS.COURSES}`, docId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return;

        let currentItems = docSnap.data().items || [];
        
        if (toDelete && indexToUpdate !== null) {
            currentItems.splice(indexToUpdate, 1);
        } else if (indexToUpdate !== null) {
            currentItems[indexToUpdate].completed = isCompleted;
        } else {
            const input = document.getElementById('new-course-item-input');
            const newItemText = input.value.trim();
            if (newItemText) {
                currentItems.push({ text: newItemText, completed: false });
                input.value = '';
                input.focus();
            } else {
                return;
            }
        }
        
        await updateDoc(docRef, { items: currentItems });
        renderCourseItems(currentItems, docId);
    }


    // --- EVENT LISTENERS INITIAUX ---
    function initializeEventListeners() {
        document.getElementById('authBtn').addEventListener('click', showAuthModal);
        document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth).then(() => showToast('D√©connect√©.', 'info')));
        document.getElementById('preferencesBtn').addEventListener('click', showPreferencesModal);
        
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) hideModal();
        });
        modeSelector.addEventListener('click', e => {
            const button = e.target.closest('button');
            if(button) setMode(button.dataset.mode);
        });
        mainNav.addEventListener('click', e => {
            const button = e.target.closest('.nav-button');
            if (button) showPage(button.dataset.target);
        });
        pageContent.addEventListener('input', e => {
            if(e.target.matches('.searchBar')) renderCurrentPageContent();
        });
        pageContent.addEventListener('click', e => {
            const card = e.target.closest('.card');
            if (card) {
                const config = NAV_CONFIG[currentMode].find(p => p.id === currentPageId);
                const entry = allDataCache[config.type]?.find(item => item.id === card.dataset.id);
                if(entry) showItemModal(entry, config.type);
            }
        });
    }

    // --- Initialisation au chargement de la page ---
    document.addEventListener('DOMContentLoaded', initializeEventListeners);

</script>
</body>
</html>
