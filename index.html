<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi de Travail</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles personnalis√©s pour les animations et les overrides sp√©cifiques */
        @keyframes expandAnimation {
            from { transform: translate(-50%, -50%) scale(0.95); opacity: 0.9; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .animate-expand {
            animation: expandAnimation 0.3s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadein {
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeinout {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }
        .animate-fadeinout {
            animation: fadeinout 4s forwards;
        }

        /* Styles d'impression */
        @media print {
            body * {
                visibility: hidden;
            }
            .expanded-card, .expanded-card * {
                visibility: visible;
            }
            .expanded-card {
                position: static !important;
                transform: none !important;
                left: auto !important;
                top: auto !important;
                margin: 0 auto !important;
                width: 100% !important;
                max-width: none !important;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                box-shadow: none !important;
                border: none !important;
                padding: 1rem !important;
                background: white !important;
                color: black !important;
            }
            .expanded-card .close-button,
            .expanded-card .actions,
            .expanded-card .add-new-item-btn,
            .expanded-card .add-step-card-btn {
                display: none !important;
            }
            .card h3, .historique strong {
                color: black !important;
            }
            .historique {
                border-left: 1px solid #ccc !important;
                background: #f9f9f9 !important;
            }
            input, textarea, [contenteditable="true"] {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-blue-50 font-sans text-gray-800 leading-relaxed min-h-screen flex flex-col">

    <header class="bg-gradient-to-r from-gray-800 to-blue-700 text-white p-6 text-center shadow-lg fixed top-0 w-full z-50 box-border h-20 flex items-center justify-between rounded-b-lg">
        <h1 class="flex-grow text-center m-0 text-3xl md:text-4xl lg:text-5xl font-extrabold">Suivi de Travail</h1>
        <div class="flex flex-col items-end gap-1">
            <span id="userIdDisplay" class="text-sm text-gray-200">Non connect√©</span>
            <button id="authBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-all duration-300 ease-in-out shadow-sm">Connexion / Inscription</button>
            <button id="signOutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-all duration-300 ease-in-out shadow-sm hidden">D√©connexion</button>
        </div>
    </header>

    <nav class="flex flex-wrap justify-center bg-gray-700 shadow-md fixed top-20 w-full z-40 box-border h-auto md:h-12 rounded-b-md hidden">
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="objectifs">üéØ Objectifs</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="actions">üìù TO DO</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="actionsTerminees">‚úÖ Actions termin√©es</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="notesReunion">üìã Notes de r√©union</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:translate-y-[-2px]" data-target="sharedItems">üåê Partag√©s</button>
    </nav>

    <main class="flex-grow pt-40 md:pt-36 pb-8 hidden">
        <div id="objectifs" class="content hidden p-4 md:p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Objectifs</h2>
            <input type="text" id="searchBarObjectifs" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher un objectif...">
            <button class="add-new-item-btn bg-blue-600 text-white border-none px-6 py-3 rounded-lg cursor-pointer text-lg block w-fit mx-auto my-4 shadow-md transition-all duration-300 ease-in-out hover:bg-blue-700 hover:translate-y-[-2px] hover:shadow-lg" data-type="objectifs">‚ûï Ajouter un objectif</button>
            <div id="objectifList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>

        <div id="actions" class="content hidden p-4 md:p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">TO DO</h2>
            <input type="text" id="searchBarActions" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher une action...">
            <button class="add-new-item-btn bg-blue-600 text-white border-none px-6 py-3 rounded-lg cursor-pointer text-lg block w-fit mx-auto my-4 shadow-md transition-all duration-300 ease-in-out hover:bg-blue-700 hover:translate-y-[-2px] hover:shadow-lg" data-type="actions">‚ûï Ajouter une action</button>
            <div id="actionList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>

        <div id="actionsTerminees" class="content hidden p-4 md:p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Actions termin√©es</h2>
            <input type="text" id="searchBarActionsTerminees" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher une action termin√©e...">
            <div id="actionTermineeList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>

        <div id="notesReunion" class="content hidden p-4 md:p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Notes de r√©union</h2>
            <input type="text" id="searchBarNotesReunion" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher une note...">
            <button class="add-new-item-btn bg-blue-600 text-white border-none px-6 py-3 rounded-lg cursor-pointer text-lg block w-fit mx-auto my-4 shadow-md transition-all duration-300 ease-in-out hover:bg-blue-700 hover:translate-y-[-2px] hover:shadow-lg" data-type="notesReunion">‚ûï Ajouter une note de r√©union</button>
            <div id="notesReunionList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>

        <div id="sharedItems" class="content hidden p-4 md:p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">√âl√©ments Partag√©s</h2>
            <p class="text-gray-700 mb-4">Ces √©l√©ments ont √©t√© partag√©s publiquement. Ils sont en lecture seule.</p>
            <input type="text" id="searchBarSharedItems" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md box-border text-base focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all duration-300 ease-in-out" placeholder="Rechercher un √©l√©ment partag√©...">
            <div id="sharedItemList" class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>
    </main>

    <div class="overlay hidden fixed inset-0 w-full h-full bg-black bg-opacity-60 z-[999] backdrop-blur-sm animate-fadein" id="overlay"></div>

    <div id="authModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded-lg shadow-2xl z-[2000] max-w-md w-11/12 hidden animate-expand">
        <span class="close-button absolute top-4 right-5 text-3xl font-bold text-gray-400 cursor-pointer z-[1001] p-2 rounded-full leading-none transition-all duration-300 ease-in-out hover:text-gray-600">&times;</span>
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Connexion / Inscription</h3>
        <div class="mb-4">
            <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
            <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="votre@email.com" autocomplete="email">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Mot de passe:</label>
            <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="********" autocomplete="current-password">
        </div>
        <div class="flex flex-col gap-3">
            <button id="signInEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 ease-in-out shadow-md">Se connecter</button>
            <button id="signUpEmailBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 ease-in-out shadow-md">S'inscrire</button>
            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400">OU</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            <button id="signInGoogleBtn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-md transition-all duration-300 ease-in-out shadow-md flex items-center justify-center gap-2 border border-gray-300">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5">
                Se connecter avec Google
            </button>
        </div>
    </div>

<script type="module">
    // Importe les modules Firebase n√©cessaires.
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, updateDoc, deleteDoc, onSnapshot, query, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Configuration Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCFMC73NLlmTzGVGcK_-zTwwNyw6-jmr7Y",
        authDomain: "suivitravailapp.firebaseapp.com",
        projectId: "suivitravailapp",
        storageBucket: "suivitravailapp.appspot.com",
        messagingSenderId: "621525076182",
        appId: "1:621525076182:web:f5a9bc1f5aaae71ce7e177",
        measurementId: "G-15HMDGYYCN"
    };

    // --- INITIALISATION FIREBASE ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // --- VARIABLES GLOBALES ---
    let userId = null;
    let expandedCardId = null; 
    let currentPageId = 'objectifs';
    let unsubscribeListeners = [];
    let allDataCache = {};

    // --- CONSTANTES ---
    const COLLECTIONS = {
        OBJECTIFS: 'objectifs',
        ACTIONS: 'actions',
        NOTES_REUNION: 'notesReunion',
        SHARED_ENTRIES: 'shared_entries'
    };
    // **CORRECTION** : Modification des classes pour une plus grande largeur
    const EXPANDED_CLASSES = ['expanded-card', 'fixed', 'top-1/2', '-translate-y-1/2', 'left-4', 'right-4', 'h-auto', 'max-h-[90vh]', 'overflow-y-auto', 'p-8', 'shadow-2xl', 'z-[1000]', 'animate-expand', 'border-2', 'border-blue-600', 'rounded-xl', 'transform-none'];


    // --- S√âLECTEURS DOM ---
    const authModal = document.getElementById('authModal');
    const overlay = document.getElementById('overlay');
    const mainContent = document.querySelector('main');
    const nav = document.querySelector('nav');

    // --- FONCTIONS UTILITAIRES & MODALES ---
    function showModalMessage(message, isError = false, showConfirmButtons = false) {
        return new Promise(resolve => {
            const container = document.createElement('div');
            const msgOverlay = document.createElement('div');
            msgOverlay.className = 'fixed inset-0 w-full h-full bg-black bg-opacity-50 z-[2999] animate-fadein';
            const messageBox = document.createElement('div');
            messageBox.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-5 rounded-lg shadow-xl z-[3000] text-center font-sans max-w-sm w-11/12 border ${isError ? 'border-red-500 text-red-600' : 'border-blue-600 text-gray-800'} animate-expand`;
            const buttonsHtml = showConfirmButtons
                ? `<button id="confirmYes" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md mr-2">Oui</button>
                   <button id="confirmNo" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">Non</button>`
                : `<button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-4">OK</button>`;
            messageBox.innerHTML = `<p class="mb-4">${message}</p><div>${buttonsHtml}</div>`;
            container.append(msgOverlay, messageBox);
            document.body.appendChild(container);
            const cleanup = (result) => { container.remove(); resolve(result); };
            if (showConfirmButtons) {
                messageBox.querySelector('#confirmYes').addEventListener('click', () => cleanup(true));
                messageBox.querySelector('#confirmNo').addEventListener('click', () => cleanup(false));
            } else {
                messageBox.querySelector('button').addEventListener('click', () => cleanup(true));
            }
            msgOverlay.addEventListener('click', () => cleanup(false));
        });
    }
    function showToastNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-5 left-1/2 -translate-x-1/2 text-white px-5 py-3 rounded-lg shadow-xl z-[3000] opacity-0 animate-fadeinout text-base flex items-center gap-2`;
        const icons = { success: '‚úîÔ∏è', error: '‚ùå', info: '‚ÑπÔ∏è' };
        const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
        toast.classList.add(colors[type] || 'bg-blue-600');
        toast.innerHTML = `${icons[type] || '‚ÑπÔ∏è'} ${message}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }
    function getTimeStamp() { return new Date().toLocaleString('fr-FR'); }
    function extractDateFromHistory(dateString) {
        if(!dateString) return new Date(0);
        const match = dateString.match(/(\d{2})\/(\d{2})\/(\d{4}) √† (\d{2}):(\d{2}):(\d{2})/);
        return match ? new Date(match[3], match[2] - 1, match[1], match[4], match[5], match[6]) : new Date(0);
    }
    function autoResizeTextarea(element) {
        element.style.height = 'auto';
        element.style.height = `${element.scrollHeight}px`;
    }
    
    // --- GESTION DE L'AUTHENTIFICATION ---
    onAuthStateChanged(auth, async (user) => {
        const authModalCloseBtn = authModal.querySelector('.close-button');
        if (user) {
            userId = user.uid;
            document.getElementById('userIdDisplay').innerText = `Connect√©: ${user.email || 'Anonyme'}`;
            document.getElementById('authBtn').classList.add('hidden');
            document.getElementById('signOutBtn').classList.remove('hidden');
            closeAuthModal();
            authModalCloseBtn.classList.remove('hidden'); 
            mainContent.classList.remove('hidden');
            nav.classList.remove('hidden');
            setupRealtimeListeners();
            showPage(currentPageId);
        } else {
            userId = null;
            document.getElementById('userIdDisplay').innerText = 'Non connect√©';
            document.getElementById('authBtn').classList.remove('hidden');
            document.getElementById('signOutBtn').classList.add('hidden');
            mainContent.classList.add('hidden');
            nav.classList.add('hidden');
            document.querySelectorAll('.grid-container').forEach(c => c.innerHTML = '');
            detachRealtimeListeners(); 
            openAuthModal();
            authModalCloseBtn.classList.add('hidden');
        }
    });
    function openAuthModal() {
        authModal.classList.remove('hidden');
        overlay.classList.remove('hidden');
    }
    function closeAuthModal() {
        if (auth.currentUser) {
            authModal.classList.add('hidden');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            if(emailInput) emailInput.value = '';
            if(passwordInput) passwordInput.value = '';
        }
    }
    function detachRealtimeListeners() {
        unsubscribeListeners.forEach(unsub => unsub());
        unsubscribeListeners = [];
    }

    // --- GESTION DES DONN√âES ET RENDU ---
    function setupRealtimeListeners() {
        if (!userId) return;
        detachRealtimeListeners();

        const createListener = (collectionName, cacheKey, isPublic = false) => {
            const path = isPublic ? `artifacts/${firebaseConfig.appId}/public/data/${collectionName}` : `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`;
            const q = query(collection(db, path));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                allDataCache[cacheKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                triggerRenderForCurrentPage();
            }, (error) => {
                console.error(`Erreur d'√©coute de ${collectionName}:`, error);
                showModalMessage(`Erreur de chargement pour ${collectionName}.`, true);
            });
            unsubscribeListeners.push(unsubscribe);
        };
        createListener(COLLECTIONS.OBJECTIFS, 'objectifs');
        createListener(COLLECTIONS.ACTIONS, 'actions');
        createListener(COLLECTIONS.NOTES_REUNION, 'notesReunion');
        createListener(COLLECTIONS.SHARED_ENTRIES, 'sharedItems', true);
    }
    function triggerRenderForCurrentPage() {
        const searchInput = document.querySelector(`#${currentPageId} .searchBar`);
        const options = { searchTerm: searchInput ? searchInput.value : '' };
        
        if (currentPageId === 'objectifs') {
            renderEntries(COLLECTIONS.OBJECTIFS, 'objectifList', allDataCache.objectifs || [], options);
        } else if (currentPageId === 'actions') {
            renderEntries(COLLECTIONS.ACTIONS, 'actionList', allDataCache.actions || [], { ...options, isAction: true, displayCompleted: false });
        } else if (currentPageId === 'actionsTerminees') {
            renderEntries('actionsTerminees', 'actionTermineeList', allDataCache.actions || [], { ...options, isAction: true, displayCompleted: true });
        } else if (currentPageId === 'notesReunion') {
            renderEntries(COLLECTIONS.NOTES_REUNION, 'notesReunionList', allDataCache.notesReunion || [], options);
        } else if (currentPageId === 'sharedItems') {
            renderEntries(COLLECTIONS.SHARED_ENTRIES, 'sharedItemList', allDataCache.sharedItems || [], { ...options, isReadOnly: true });
        }
    }
    function renderEntries(type, containerId, data, options = {}) {
        const { isAction = false, displayCompleted = false, isReadOnly = false, searchTerm = '' } = options;
        const container = document.getElementById(containerId);
        if (!container) return;

        const scrollPosition = container.scrollTop;
        container.innerHTML = '';
        let filteredData = data.filter(entry => {
            if (isAction && (!!entry.isCompleted !== displayCompleted)) return false;
            if (searchTerm) {
                const content = [entry.titre, entry.contenu, entry.description, entry.progressComments, ...(entry.tags || [])]
                    .join(' ').toLowerCase();
                return content.includes(searchTerm.toLowerCase());
            }
            return true;
        }).sort((a, b) => {
            const dateA = type === COLLECTIONS.ACTIONS ? (a.deadLine ? new Date(a.deadLine) : new Date(8e15)) : extractDateFromHistory(a.historique?.[0]);
            const dateB = type === COLLECTIONS.ACTIONS ? (b.deadLine ? new Date(b.deadLine) : new Date(8e15)) : extractDateFromHistory(b.historique?.[0]);
            return type === COLLECTIONS.ACTIONS ? dateA - dateB : dateB - dateA;
        });

        if (filteredData.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-600 col-span-full mt-12">${searchTerm ? 'Aucun r√©sultat.' : 'Aucun √©l√©ment √† afficher.'}</p>`;
            return;
        }

        filteredData.forEach(entry => {
            const cardDiv = createCardElement(entry, type, isReadOnly);
            if (expandedCardId === entry.id) {
                expandCard(cardDiv, isReadOnly);
            }
            container.appendChild(cardDiv);
        });
        container.scrollTop = scrollPosition;
    }
    
    // --- GESTION DE L'INTERFACE ---
    function showPage(id) {
        currentPageId = id;
        document.querySelectorAll('.content').forEach(s => s.classList.add('hidden'));
        const activePage = document.getElementById(id);
        if (activePage) activePage.classList.remove('hidden');
        closeExpandedCard();
        document.querySelectorAll('nav .nav-button').forEach(b => {
            b.classList.toggle('bg-blue-600', b.dataset.target === id);
            b.classList.toggle('font-bold', b.dataset.target === id);
        });
        triggerRenderForCurrentPage();
    }
    function closeExpandedCard() {
        const currentlyExpanded = document.querySelector('.expanded-card');
        if (currentlyExpanded) {
            if (currentlyExpanded.dataset.type?.startsWith('new-')) {
                currentlyExpanded.remove();
            } else {
                currentlyExpanded.classList.remove(...EXPANDED_CLASSES);
                currentlyExpanded.querySelector('.hidden-detail')?.classList.add('hidden');
                currentlyExpanded.querySelector('.close-button')?.remove();
            }
        }
        overlay.classList.add('hidden');
        expandedCardId = null;
    }
    function expandCard(cardElement, isReadOnly) {
        cardElement.classList.add(...EXPANDED_CLASSES);
        cardElement.style.transform = 'translateY(-50%)'; // Correction pour centrage vertical
        cardElement.querySelector('.hidden-detail')?.classList.remove('hidden');
        overlay.classList.remove('hidden');
        const closeButton = document.createElement('span');
        closeButton.className = 'close-button absolute top-4 right-5 text-3xl font-bold text-gray-400 cursor-pointer z-[1001] p-2';
        closeButton.innerHTML = '&times;';
        closeButton.onclick = (e) => { e.stopPropagation(); closeExpandedCard(); };
        cardElement.appendChild(closeButton);
        if (!isReadOnly) addCardEventListeners(cardElement, cardElement.dataset.type, cardElement.dataset.id);
        expandedCardId = cardElement.dataset.id;
    }
    function toggleCardExpansion(event, cardElement, isReadOnly = false) {
        if (event.target.closest('.actions button, [contenteditable="true"], textarea, input, .tag-item, .add-step-card-btn, .remove-step')) return;
        const cardId = cardElement.dataset.id;
        if (expandedCardId && expandedCardId !== cardId) closeExpandedCard();
        if (cardElement.classList.contains('expanded-card')) {
            closeExpandedCard();
        } else {
            expandCard(cardElement, isReadOnly);
        }
    }
    function createCardElement(entry, type, isReadOnly) {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card bg-white p-5 rounded-lg shadow-lg cursor-pointer transition-all duration-300 ease-in-out relative flex flex-col border border-gray-200 hover:translate-y-[-5px] hover:shadow-xl';
        cardDiv.dataset.id = entry.id;
        cardDiv.dataset.type = type;
        cardDiv.addEventListener('click', (event) => toggleCardExpansion(event, cardDiv, isReadOnly));
        
        const originalType = isReadOnly ? entry.originalCollection : type;
        
        let cardContent = `<h3 class="text-xl font-bold text-gray-800 mb-2 break-words">${entry.titre || ''}</h3>`;
        let hiddenDetailContent = `<p class="mb-2"><strong>Titre:</strong> <span contenteditable="${!isReadOnly}" data-field="titre" class="inline-block p-1 rounded-md border border-gray-300 w-full">${entry.titre || ''}</span></p>`;
        
        let actionButtons = !isReadOnly
            ? `<button class="delete bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="delete">üóëÔ∏è Supprimer</button>
               <button class="share bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="share">üîó Partager</button>`
            : '';
        actionButtons += `<button class="print bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="print">üñ®Ô∏è Imprimer</button>`;

        if (originalType === COLLECTIONS.NOTES_REUNION) {
            cardContent += `<p class="text-gray-700 text-sm break-words">${(entry.contenu || '').substring(0, 100)}...</p>`;
            hiddenDetailContent += `<p class="mb-2"><strong>Contenu:</strong> <textarea data-field="contenu" class="w-full p-2 mb-4 rounded-md border border-gray-300 min-h-[120px]">${entry.contenu || ''}</textarea></p>`;
        } else if (originalType === COLLECTIONS.ACTIONS) {
            cardContent += `<p class="text-gray-700 text-sm">Deadline: <strong class="text-blue-700">${entry.deadLine ? new Date(entry.deadLine).toLocaleDateString('fr-FR') : 'N/A'}</strong></p>`;
            hiddenDetailContent += `<p class="mb-2"><strong>Deadline:</strong> <input type="date" value="${entry.deadLine || ''}" data-field="deadLine" class="w-full p-2 mb-4 rounded-md border border-gray-300"></p>
                                    <p class="mb-2"><strong>√âtapes:</strong></p><div class="steps-list" data-field="etapes-container"></div>
                                    ${!isReadOnly ? `<button type="button" class="add-step-card-btn bg-blue-600 text-white font-bold py-1 px-2 rounded text-xs mt-2">‚ûï √âtape</button>` : ''}`;
            if (!isReadOnly) {
                actionButtons += entry.isCompleted
                    ? `<button class="reintegrate bg-yellow-500 text-gray-800 font-bold py-2 px-4 rounded-md text-sm" data-action="reintegrate">‚Ü©Ô∏è R√©int√©grer</button>`
                    : `<button class="mark-as-complete bg-cyan-600 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="mark-as-complete">‚úÖ Terminer</button>`;
            }
        } else if (originalType === COLLECTIONS.OBJECTIFS) {
            const pct = entry.pourcentage || 0;
            const progressClass = pct < 25 ? 'bg-red-500' : (pct < 75 ? 'bg-yellow-500' : 'bg-green-500');
            cardContent += `<div class="progress-bar bg-gray-200 rounded-md h-6 my-3"><div class="h-full text-center text-white font-bold leading-6 ${progressClass}" style="width: ${pct}%">${pct}%</div></div>`;
            hiddenDetailContent += `<p class="mb-2"><strong>R√©alisation:</strong> <span class="progress-value font-bold">${pct}%</span></p>
                                    <input type="range" min="0" max="100" value="${pct}" data-field="pourcentage_range" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                                    <p class="mb-2"><strong>Description:</strong> <textarea data-field="description" class="w-full p-2 mb-4 rounded-md border border-gray-300 min-h-[100px]">${entry.description || ''}</textarea></p>
                                    <p class="mb-2"><strong>Commentaires:</strong> <textarea data-field="progressComments" class="w-full p-2 mb-4 rounded-md border border-gray-300 min-h-[100px]">${entry.progressComments || ''}</textarea></p>`;
            if (!isReadOnly) actionButtons += `<button class="move bg-gray-500 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="move" data-to="${COLLECTIONS.ACTIONS}">‚û°Ô∏è Vers Actions</button>`;
        }
        
        const tagsHtml = (entry.tags || []).length > 0 ? `<div class="tags-display mt-2 text-sm flex flex-wrap gap-1">${entry.tags.map(t => `<span class="tag-item bg-gray-200 px-2 py-1 rounded-full text-xs">${t}</span>`).join('')}</div>` : '';
        cardContent += tagsHtml;
        hiddenDetailContent += `<p class="mb-2"><strong>Tags (s√©par√©s par ,):</strong> <span contenteditable="${!isReadOnly}" data-field="tags" class="inline-block p-1 rounded-md border border-gray-300 w-full">${(entry.tags || []).join(', ')}</span></p>`;

        if (isReadOnly) hiddenDetailContent += `<p class="text-xs text-gray-500 mt-4">Partag√© par: <strong class="text-gray-700">${entry.originalUserId}</strong> le ${entry.sharedAt}</p>`;
        
        cardDiv.innerHTML = `<div class="card-content">${cardContent}</div>
            <div class="hidden-detail hidden flex-grow pt-4 border-t border-gray-200 mt-4">
                ${hiddenDetailContent}
                <div class="actions flex flex-wrap gap-3 mt-6 justify-end pt-4 border-t border-gray-200">${actionButtons}</div>
                <div class="historique text-sm text-gray-600 mt-6 bg-gray-100 p-4 border-l-4 border-blue-600 rounded-md max-h-40 overflow-y-auto">
                    <strong>Historique :</strong><br>${(entry.historique || []).slice().reverse().map(l => `‚Ä¢ ${l}`).join('<br>')}
                </div>
            </div>`;
        
        if (originalType === COLLECTIONS.ACTIONS && !isReadOnly) {
            const stepsContainer = cardDiv.querySelector('.steps-list');
            (entry.etapes || []).forEach((step, index) => addStepInput(stepsContainer, step, index));
            cardDiv.querySelector('.add-step-card-btn')?.addEventListener('click', e => { e.stopPropagation(); addStepInput(stepsContainer, '', (entry.etapes || []).length); });
        }
        return cardDiv;
    }

    // --- LOGIQUE M√âTIER (CRUD, etc.) ---
    async function addEntry(collectionName, modalNode) {
        if (!userId) return;
        let newEntry = { historique: [`Cr√©√© le ${getTimeStamp()}`] };
        try {
            if (collectionName === COLLECTIONS.OBJECTIFS) {
                newEntry.titre = modalNode.querySelector('#modalObjectifTitre').value.trim();
                newEntry.pourcentage = parseInt(modalNode.querySelector('#modalObjectifPourcentage').value) || 0;
                newEntry.description = modalNode.querySelector('#modalObjectifDescription').value.trim();
                newEntry.progressComments = modalNode.querySelector('#modalObjectifProgressComments').value.trim();
                newEntry.tags = modalNode.querySelector('#modalObjectifTags').value.split(',').map(t => t.trim()).filter(Boolean);
            } else if (collectionName === COLLECTIONS.ACTIONS) {
                newEntry.titre = modalNode.querySelector('#modalActionTitre').value.trim();
                newEntry.deadLine = modalNode.querySelector('#modalActionDeadLine').value;
                newEntry.etapes = Array.from(modalNode.querySelectorAll('input[data-field="step-input"]')).map(i => i.value.trim()).filter(Boolean);
                newEntry.isCompleted = false;
                newEntry.tags = modalNode.querySelector('#modalActionTags').value.split(',').map(t => t.trim()).filter(Boolean);
            } else if (collectionName === COLLECTIONS.NOTES_REUNION) {
                newEntry.titre = modalNode.querySelector('#modalNoteReunionTitre').value.trim();
                newEntry.contenu = modalNode.querySelector('#modalNoteReunionContenu').value.trim();
                newEntry.tags = modalNode.querySelector('#modalNoteReunionTags').value.split(',').map(t => t.trim()).filter(Boolean);
            }
            if (!newEntry.titre) throw new Error("Le titre est obligatoire.");
            const collectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`);
            await addDoc(collectionRef, newEntry);
            showToastNotification("√âl√©ment ajout√© !", 'success');
            closeExpandedCard();
        } catch (error) { showModalMessage(`Erreur: ${error.message}`, true); }
    }
    async function deleteEntry(collectionName, id) {
        if (!userId) return;
        if (await showModalMessage("Supprimer cet √©l√©ment ?", false, true)) {
            try {
                await deleteDoc(doc(db, `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`, id));
                showToastNotification("√âl√©ment supprim√©.", 'success');
                closeExpandedCard();
            } catch (error) { showModalMessage(`Erreur: ${error.message}`, true); }
        }
    }
    async function updateFieldFromCard(collectionName, id, field, value, silent = false) {
        if (!userId) return;
        const docRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`, id);
        try {
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists() || JSON.stringify(docSnap.data()[field]) === JSON.stringify(value)) return;
            const updates = { [field]: value };
            if (!silent) updates.historique = [...(docSnap.data().historique || []), `Champ '${field}' mis √† jour le ${getTimeStamp()}`];
            await updateDoc(docRef, updates);
            if (!silent) showToastNotification("Mise √† jour r√©ussie.", 'success');
        } catch (error) { showModalMessage(`Erreur de mise √† jour: ${error.message}`, true); }
    }
    async function markAsCompleted(id) {
        if (!userId) return;
        const docRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${userId}/${COLLECTIONS.ACTIONS}`, id);
        try {
            const currentData = (await getDoc(docRef)).data();
            await updateDoc(docRef, { isCompleted: true, historique: [...(currentData.historique || []), `Termin√©e le ${getTimeStamp()}`] });
            showToastNotification("Action termin√©e !", 'success');
            closeExpandedCard();
            showPage('actionsTerminees');
        } catch(error) { showModalMessage(`Erreur: ${error.message}`, true); }
    }
    async function reintegrateAction(id) {
        if (!userId) return;
        const docRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${userId}/${COLLECTIONS.ACTIONS}`, id);
        try {
            const currentData = (await getDoc(docRef)).data();
            await updateDoc(docRef, { isCompleted: false, historique: [...(currentData.historique || []), `R√©int√©gr√©e le ${getTimeStamp()}`] });
            showToastNotification("Action r√©int√©gr√©e.", 'info');
            closeExpandedCard();
            showPage('actions');
        } catch(error) { showModalMessage(`Erreur: ${error.message}`, true); }
    }
    function printCard() { window.print(); }
    function addStepInput(container, value, index, isModal=false) {
        const li = document.createElement('li');
        li.className = 'flex items-center mb-1';
        li.innerHTML = `<input type="text" value="${value}" placeholder="Nouvelle √©tape" data-index="${index}" data-field="step-input" class="flex-grow p-1 rounded-md border border-gray-300 text-sm mr-2">
                        <button class="remove-step bg-red-500 text-white font-bold py-1 px-2 rounded-md text-xs">‚úñÔ∏è</button>`;
        container.appendChild(li);
        const input = li.querySelector('input');
        const updateSteps = () => {
            if (!isModal) {
                const card = container.closest('.card');
                const allSteps = Array.from(card.querySelectorAll('input[data-field="step-input"]')).map(i => i.value.trim()).filter(Boolean);
                updateFieldFromCard(COLLECTIONS.ACTIONS, card.dataset.id, 'etapes', allSteps, true);
            }
        };
        input.addEventListener('blur', updateSteps);
        li.querySelector('.remove-step').addEventListener('click', (e) => { e.stopPropagation(); li.remove(); updateSteps(); });
    }
    function addCardEventListeners(card, collectionName, id) {
        card.querySelectorAll('[contenteditable], textarea, input[type="date"]').forEach(el => {
            const listener = (e) => {
                const field = e.target.dataset.field;
                const value = e.target.tagName === 'SPAN' ? e.target.innerText : e.target.value;
                updateFieldFromCard(collectionName, id, field, field === 'tags' ? value.split(',').map(t=>t.trim()).filter(Boolean) : value);
            };
            el.addEventListener('blur', listener);
        });
        card.querySelector('input[data-field="pourcentage_range"]')?.addEventListener('change', e => updateFieldFromCard(collectionName, id, 'pourcentage', parseInt(e.target.value)));
        card.querySelectorAll('.actions button').forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener('click', e => {
                e.stopPropagation();
                const action = newBtn.dataset.action;
                if (action === 'delete') deleteEntry(collectionName, id);
                if (action === 'print') printCard();
                if (action === 'mark-as-complete') markAsCompleted(id);
                if (action === 'reintegrate') reintegrateAction(id);
            });
        });
    }
    function openNewItemModal(type) {
        if (!userId) return showModalMessage("Veuillez vous connecter.", true);
        closeExpandedCard();
        const modalCard = document.createElement('div');
        modalCard.className = `card bg-white ${EXPANDED_CLASSES.join(' ')}`;
        modalCard.dataset.type = 'new-' + type;
        let title = '', formHtml = '';
        if (type === COLLECTIONS.OBJECTIFS) {
            title = 'Ajouter un objectif';
            formHtml = `<input id="modalObjectifTitre" placeholder="Titre" required class="w-full p-2 mb-4 border rounded"><input type="number" id="modalObjectifPourcentage" placeholder="%" value="0" class="w-full p-2 mb-4 border rounded"><textarea id="modalObjectifDescription" placeholder="Description" required class="w-full p-2 mb-4 border rounded min-h-[80px]"></textarea><textarea id="modalObjectifProgressComments" placeholder="Commentaires" class="w-full p-2 mb-4 border rounded min-h-[80px]"></textarea><input id="modalObjectifTags" placeholder="Tags (s√©par√©s par ,)" class="w-full p-2 mb-4 border rounded">`;
        } else if (type === COLLECTIONS.ACTIONS) {
            title = 'Ajouter une action';
            formHtml = `<input id="modalActionTitre" placeholder="Titre" required class="w-full p-2 mb-4 border rounded"><input type="date" id="modalActionDeadLine" required class="w-full p-2 mb-4 border rounded"><div class="mb-4"><label class="block mb-1 font-bold">√âtapes:</label><div class="steps-list"></div><button type="button" id="modalAddStepBtn" class="bg-blue-600 text-white font-bold py-1 px-2 rounded text-xs mt-2">‚ûï</button></div><input id="modalActionTags" placeholder="Tags (s√©par√©s par ,)" class="w-full p-2 mb-4 border rounded">`;
        } else if (type === COLLECTIONS.NOTES_REUNION) {
            title = 'Ajouter une note de r√©union';
            formHtml = `<input id="modalNoteReunionTitre" placeholder="Titre" required class="w-full p-2 mb-4 border rounded"><textarea id="modalNoteReunionContenu" placeholder="Contenu" required class="w-full p-2 mb-4 border rounded min-h-[120px]"></textarea><input id="modalNoteReunionTags" placeholder="Tags (s√©par√©s par ,)" class="w-full p-2 mb-4 border rounded">`;
        }
        modalCard.innerHTML = `<span class="close-button absolute top-4 right-5 text-3xl cursor-pointer">&times;</span><div class="p-6 mt-8"><h3 class="text-xl font-bold mb-6 border-b-2 pb-2">${title}</h3>${formHtml}<div class="flex justify-center gap-3 mt-6 pt-4"><button class="submit bg-green-600 text-white font-bold py-2 px-4 rounded">‚ûï Ajouter</button><button class="cancel bg-gray-500 text-white font-bold py-2 px-4 rounded">Annuler</button></div></div>`;
        document.body.appendChild(modalCard);
        overlay.classList.remove('hidden');
        modalCard.querySelector('.close-button').addEventListener('click', closeExpandedCard);
        modalCard.querySelector('.cancel').addEventListener('click', closeExpandedCard);
        modalCard.querySelector('.submit').addEventListener('click', () => addEntry(type, modalCard));
        if (type === COLLECTIONS.ACTIONS) {
            const stepsContainer = modalCard.querySelector('.steps-list');
            modalCard.querySelector('#modalAddStepBtn').addEventListener('click', () => addStepInput(stepsContainer, '', 0, true));
            addStepInput(stepsContainer, '', 0, true);
        }
    }

    // --- INITIALISATION DES √âV√âNEMENTS ---
    function initializeEventListeners() {
        nav.addEventListener('click', e => {
            if (e.target.matches('.nav-button')) showPage(e.target.dataset.target);
        });
        mainContent.addEventListener('click', e => {
            if (e.target.matches('.add-new-item-btn')) openNewItemModal(e.target.dataset.type);
        });
        mainContent.addEventListener('keyup', e => {
            if(e.target.matches('.searchBar')) triggerRenderForCurrentPage();
        });
        
        overlay.addEventListener('click', () => { closeExpandedCard(); closeAuthModal(); });
        
        const authContainer = document.getElementById('authModal');
        authContainer.querySelector('.close-button').addEventListener('click', closeAuthModal);
        authContainer.querySelector('#signInEmailBtn').addEventListener('click', async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch (e) { showModalMessage(`Erreur: ${e.message}`, true); } });
        authContainer.querySelector('#signUpEmailBtn').addEventListener('click', async () => { try { await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch (e) { showModalMessage(`Erreur: ${e.message}`, true); } });
        authContainer.querySelector('#signInGoogleBtn').addEventListener('click', async () => { try { await signInWithPopup(auth, googleProvider); } catch (e) { showModalMessage(`Erreur: ${e.message}`, true); } });
        document.getElementById('signOutBtn').addEventListener('click', async () => { try { await signOut(auth); } catch (e) { showModalMessage(`Erreur: ${e.message}`, true); } });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initializeEventListeners();
    });

</script>
</body>
</html>
