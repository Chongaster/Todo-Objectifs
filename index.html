<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi de Travail</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles pour les animations et l'impression */
        @keyframes expandAnimation {
            from { transform: translate(-50%, -50%) scale(0.95); opacity: 0.9; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .animate-expand { animation: expandAnimation 0.3s forwards; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadein { animation: fadeIn 0.3s forwards; }

        @keyframes fadeinout {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }
        .animate-fadeinout { animation: fadeinout 4s forwards; }

        @media print {
            body * { visibility: hidden; }
            .expanded-card, .expanded-card * { visibility: visible; }
            .expanded-card {
                position: static !important;
                transform: none !important;
                box-shadow: none !important;
                border: none !important;
                width: 100% !important; max-width: none !important;
                height: auto !important; max-height: none !important;
                overflow: visible !important; padding: 1rem !important;
                background: white !important; color: black !important;
            }
            .expanded-card .close-button, .expanded-card .actions, .add-new-item-btn { display: none !important; }
            input, textarea, [contenteditable="true"] {
                border: none !important; background: transparent !important;
                -webkit-print-color-adjust: exact; color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-blue-50 font-sans text-gray-800 min-h-screen flex flex-col">

    <header class="bg-gradient-to-r from-gray-800 to-blue-700 text-white p-6 text-center shadow-lg fixed top-0 w-full z-50 h-20 flex items-center justify-between rounded-b-lg">
        <h1 class="flex-grow text-center m-0 text-3xl md:text-4xl lg:text-5xl font-extrabold">Suivi de Travail</h1>
        <div class="flex flex-col items-end gap-1">
            <span id="userIdDisplay" class="text-sm text-gray-200">Chargement...</span>
            <button id="authBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-xs shadow-sm">Connexion</button>
            <button id="signOutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-xs shadow-sm hidden">D√©connexion</button>
        </div>
    </header>

    <nav id="appNav" class="flex flex-wrap justify-center bg-gray-700 shadow-md fixed top-20 w-full z-40 h-12 rounded-b-md hidden">
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:-translate-y-0.5" data-target="objectifs">üéØ Objectifs</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:-translate-y-0.5" data-target="actions">üìù TO DO</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:-translate-y-0.5" data-target="actionsTerminees">‚úÖ Actions termin√©es</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:-translate-y-0.5" data-target="notesReunion">üìã Notes de r√©union</button>
        <button class="nav-button bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-all duration-300 ease-in-out rounded hover:bg-blue-500 hover:-translate-y-0.5" data-target="sharedItems">üåê Partag√©s</button>
    </nav>

    <main id="appMain" class="flex-grow pt-36 pb-8 hidden">
        <div id="objectifs" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Objectifs</h2>
            <input type="text" id="searchBarObjectifs" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all" placeholder="Rechercher un objectif...">
            <button class="add-new-item-btn bg-blue-600 text-white px-6 py-3 rounded-lg cursor-pointer text-lg block w-fit mx-auto my-4 shadow-md transition-transform hover:bg-blue-700 hover:-translate-y-0.5" data-type="objectifs">‚ûï Ajouter un objectif</button>
            <div id="objectifList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>
        <div id="actions" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">TO DO</h2>
            <input type="text" id="searchBarActions" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all" placeholder="Rechercher une action...">
            <button class="add-new-item-btn bg-blue-600 text-white px-6 py-3 rounded-lg cursor-pointer text-lg block w-fit mx-auto my-4 shadow-md transition-transform hover:bg-blue-700 hover:-translate-y-0.5" data-type="actions">‚ûï Ajouter une action</button>
            <div id="actionList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>
        <div id="actionsTerminees" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Actions termin√©es</h2>
            <input type="text" id="searchBarActionsTerminees" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all" placeholder="Rechercher une action termin√©e...">
            <div id="actionTermineeList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>
        <div id="notesReunion" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Notes de r√©union</h2>
            <input type="text" id="searchBarNotesReunion" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all" placeholder="Rechercher une note...">
            <button class="add-new-item-btn bg-blue-600 text-white px-6 py-3 rounded-lg cursor-pointer text-lg block w-fit mx-auto my-4 shadow-md transition-transform hover:bg-blue-700 hover:-translate-y-0.5" data-type="notesReunion">‚ûï Ajouter une note</button>
            <div id="notesReunionList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>
        <div id="sharedItems" class="content hidden p-8 max-w-6xl mx-auto bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">√âl√©ments Partag√©s</h2>
            <p class="text-gray-700 mb-4">Ces √©l√©ments ont √©t√© partag√©s publiquement et sont en lecture seule.</p>
            <input type="text" id="searchBarSharedItems" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none transition-all" placeholder="Rechercher un √©l√©ment partag√©...">
            <div id="sharedItemList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4"></div>
        </div>
    </main>

    <div id="overlay" class="overlay hidden fixed inset-0 w-full h-full bg-black bg-opacity-60 z-[999] backdrop-blur-sm animate-fadein"></div>

    <div id="authModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded-lg shadow-2xl z-[2000] max-w-md w-11/12 hidden animate-expand">
        <span class="close-button absolute top-4 right-5 text-3xl font-bold text-gray-400 cursor-pointer z-[1001]">&times;</span>
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Connexion / Inscription</h3>
        <div class="mb-4">
            <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
            <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 focus:outline-none focus:shadow-outline" placeholder="votre@email.com">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Mot de passe:</label>
            <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 focus:outline-none focus:shadow-outline" placeholder="********">
        </div>
        <div class="flex flex-col gap-3">
            <button id="signInEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md">Se connecter</button>
            <button id="signUpEmailBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md">S'inscrire</button>
            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400">OU</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            <button id="signInGoogleBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-md flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M1 1h22v22H1z" fill="none"/></svg>
                Se connecter avec Google
            </button>
        </div>
    </div>

    <script type="module">
        // Import des modules Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Configuration Firebase (gard√©e telle quelle)
        const firebaseConfig = {
            apiKey: "AIzaSyCFMC73NLlmTzGVGcK_-zTwwNyw6-jmr7Y",
            authDomain: "suivitravailapp.firebaseapp.com",
            projectId: "suivitravailapp",
            storageBucket: "suivitravailapp.firebasestorage.app",
            messagingSenderId: "621525076182",
            appId: "1:621525076182:web:f5a9bc1f5aaae71ce7e177",
            measurementId: "G-15HMDGYYCN"
        };

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // Variables globales d'√©tat
        let userId = null;
        let expandedCard = null;
        let currentPageId = 'objectifs';
        let activeListeners = []; // Pour stocker les √©couteurs et les d√©tacher proprement

        // Constantes pour les noms de collections
        const COLLECTIONS = {
            OBJECTIFS: 'objectifs',
            ACTIONS: 'actions',
            NOTES_REUNION: 'notesReunion',
            SHARED_ENTRIES: 'shared_entries'
        };

        // R√©f√©rences aux √©l√©ments du DOM
        const authModal = document.getElementById('authModal');
        const overlay = document.getElementById('overlay');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signInEmailBtn = document.getElementById('signInEmailBtn');
        const signUpEmailBtn = document.getElementById('signUpEmailBtn');
        const signInGoogleBtn = document.getElementById('signInGoogleBtn');
        const authBtn = document.getElementById('authBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const appNav = document.getElementById('appNav');
        const appMain = document.getElementById('appMain');

        // --- FONCTIONS UTILITAIRES ---

        /**
         * D√©tache tous les √©couteurs Firestore actifs pour √©viter les erreurs lors de la d√©connexion.
         */
        function unsubscribeAllListeners() {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
        }

        /**
         * Affiche une bo√Æte de message modale personnalis√©e.
         */
        function showModalMessage(message, isError = false, showConfirmButtons = false) {
            // ... (code de la fonction showModalMessage, inchang√©)
        }

        /**
         * Affiche une notification toast non-intrusive.
         */
        function showToastNotification(message, type = 'info') {
            // ... (code de la fonction showToastNotification, inchang√©)
        }
        
        // --- LOGIQUE DE L'INTERFACE UTILISATEUR (UI) ---

        /**
         * Affiche une page de contenu sp√©cifique et masque les autres.
         */
        function showPage(id) {
            // ... (code de la fonction showPage, inchang√©)
        }

        /**
         * Bascule l'√©tat d'expansion d'une carte (l'affiche comme modale ou la ferme).
         */
        async function toggleCardExpansion(event, cardElement, isReadOnly = false) {
            if (event.target.closest('.actions button') || event.target.closest('[contenteditable="true"], textarea, input')) {
                return;
            }
            // ...
            // Utilise 'max-w-5xl' pour une carte plus large
            expandedCard.classList.add('expanded-card', 'fixed', 'top-1/2', 'left-1/2', '-translate-x-1/2', '-translate-y-1/2', 'w-[95%]', 'max-w-5xl', 'h-auto', 'max-h-[90vh]', 'overflow-y-auto', 'p-8', 'shadow-2xl', 'z-[1000]', 'animate-expand', 'border-2', 'border-blue-600', 'rounded-xl');
            // ...
        }

        /**
         * Ouvre une modale pour ajouter un nouvel √©l√©ment.
         */
        function openNewItemModal(type) {
             if (!userId) {
                showModalMessage("Veuillez vous connecter pour ajouter des √©l√©ments.", true);
                return;
            }
            closeExpandedCard();
            const modalCard = document.createElement('div');
            // Utilise 'max-w-5xl' pour une modale plus large
            modalCard.className = 'card expanded-card fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-5xl h-auto max-h-[90vh] overflow-y-auto p-8 shadow-2xl z-[1000] animate-expand border-2 border-blue-600 rounded-xl';
            // ...
        }

        /**
         * Ferme la carte actuellement √©tendue.
         */
        function closeExpandedCard() {
            // ... (code de la fonction closeExpandedCard, inchang√©)
        }

        // --- GESTION DES DONN√âES (FIRESTORE) ---

        /**
         * Met en place les √©couteurs en temps r√©el pour chaque collection.
         */
        function setupRealtimeListeners() {
            if (!userId) return;
            
            unsubscribeAllListeners(); // D√©tache les anciens √©couteurs avant d'en cr√©er de nouveaux

            const collectionsToListen = [
                // ... (configuration des collections, inchang√©e)
            ];

            collectionsToListen.forEach(c => {
                const path = c.public 
                    ? `artifacts/${firebaseConfig.appId}/public/data/${c.name}`
                    : `artifacts/${firebaseConfig.appId}/users/${userId}/${c.realCollection || c.name}`;
                
                const unsubscribe = onSnapshot(collection(db, path), (snapshot) => {
                    let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // ... (logique de rendu, inchang√©e)
                }, (error) => {
                    // On n'affiche plus de message √† l'utilisateur, seulement dans la console pour le d√©bogage.
                    console.error(`Erreur d'√©coute de ${c.name} (probablement due √† la d√©connexion):`, error);
                });
                
                activeListeners.push(unsubscribe); // Stocke la fonction de d√©tachement
            });
        }

        /**
         * Rend les entr√©es (cartes) pour une section donn√©e.
         */
        async function renderEntries(type, containerId, isAction, displayCompletedActions, dataFromDB, isReadOnly = false) {
            // ... (code de la fonction renderEntries, avec la correction pour la taille `max-w-5xl` lors du redessinage)
        }

        // ... (Toutes les autres fonctions de gestion de donn√©es : addEntry, deleteEntry, updateFieldFromCard, etc.)


        // --- AUTHENTIFICATION ---

        /**
         * Le contr√¥leur principal de l'application, g√®re l'√©tat de connexion.
         */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Utilisateur connect√©
                userId = user.uid;
                userIdDisplay.innerText = `Utilisateur: ${user.email || 'Anonyme'}`;
                authBtn.classList.add('hidden');
                signOutBtn.classList.remove('hidden');

                // Affiche l'application
                appNav.classList.remove('hidden');
                appMain.classList.remove('hidden');
                closeAuthModal();

                setupRealtimeListeners();
                showPage(currentPageId);
            } else {
                // Utilisateur d√©connect√©
                unsubscribeAllListeners(); // D√©tache les √©couteurs pour √©viter les erreurs

                userId = null;
                userIdDisplay.innerText = 'Non connect√©';
                authBtn.classList.remove('hidden');
                signOutBtn.classList.add('hidden');

                // Cache l'application et force la modale de connexion
                appNav.classList.add('hidden');
                appMain.classList.add('hidden');
                openAuthModal(true); // `true` pour forcer (cacher le bouton fermer)
            }
        });
        
        function openAuthModal(isForced = false) {
            authModal.classList.remove('hidden');
            overlay.classList.add('active', 'block');
            authModal.querySelector('.close-button').style.display = isForced ? 'none' : 'block';
        }

        function closeAuthModal() {
            authModal.classList.add('hidden');
            overlay.classList.remove('active', 'block');
        }


        // --- √âCOUTEURS D'√âV√âNEMENTS INITIAUX ---

        document.addEventListener('DOMContentLoaded', () => {
            // Navigation
            document.querySelectorAll('.nav-button').forEach(b => b.addEventListener('click', () => showPage(b.dataset.target)));
            // Boutons "Ajouter"
            document.querySelectorAll('.add-new-item-btn').forEach(b => b.addEventListener('click', () => openNewItemModal(b.dataset.type)));
            // Barres de recherche
            document.querySelectorAll('.searchBar').forEach(input => input.addEventListener('keyup', () => setupRealtimeListeners()));

            // Overlay
            overlay.addEventListener('click', () => {
                if (auth.currentUser) { // Ne ferme que si l'utilisateur est connect√©
                    closeExpandedCard();
                    closeAuthModal();
                }
            });

            // Authentification
            authBtn.addEventListener('click', () => openAuthModal());
            authModal.querySelector('.close-button').addEventListener('click', closeAuthModal);
            
            signInEmailBtn.addEventListener('click', async () => { /* ... */ });
            signUpEmailBtn.addEventListener('click', async () => { /* ... */ });
            signInGoogleBtn.addEventListener('click', async () => { /* ... */ });

            signOutBtn.addEventListener('click', async () => {
                await signOut(auth);
                showToastNotification('D√©connect√© avec succ√®s.', 'info');
            });

            // Affiche la page par d√©faut au chargement
            showPage('objectifs');
        });

    </script>
</body>
</html>
