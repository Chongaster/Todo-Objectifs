<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Klaro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✅</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✅</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles pour les animations, le rendu et l'impression */
        @keyframes expandAnimation {
            from { transform: translate(-50%, -50%) scale(0.95); opacity: 0.9; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .animate-expand { animation: expandAnimation 0.3s forwards; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadein { animation: fadeIn 0.3s forwards; }

        @keyframes fadeinout {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }
        .animate-fadeinout { animation: fadeinout 4s forwards; }

        /* Styles pour les champs et les états spécifiques */
        .nav-button { @apply bg-transparent text-white border-none px-4 py-2 cursor-pointer flex-grow text-lg transition-colors duration-200 flex items-center justify-center; }
        .nav-button:hover { @apply bg-gray-600; }
        .nav-button.active { @apply bg-blue-600 font-bold shadow-inner; }
        
        .mode-selector button { @apply px-6 py-2 text-lg font-bold rounded-lg transition-all duration-200; }
        .mode-selector button.active { @apply bg-white text-blue-700 shadow-lg; }
        .mode-selector button:not(.active) { @apply bg-blue-500 text-white; }

        .deadline-overdue { @apply text-red-500 font-semibold; }
        
        .editable-field {
            @apply block w-full p-2 mb-4 border border-gray-300 rounded-md bg-gray-50 transition-all duration-200;
        }
        .editable-field:focus {
            @apply bg-white border-blue-600 ring-2 ring-blue-300 outline-none;
        }
        textarea.editable-field { @apply min-h-[100px]; }

        .course-item input:checked + span {
            @apply line-through text-gray-400;
        }

        /* Styles d'impression */
        @media print {
            body * { visibility: hidden; }
            .expanded-card, .expanded-card * { visibility: visible; }
            .expanded-card {
                position: static !important; transform: none !important;
                left: auto !important; top: auto !important; margin: 0 auto !important; 
                width: 100% !important; max-width: none !important; height: auto !important;
                max-height: none !important; overflow: visible !important; box-shadow: none !important; 
                border: none !important; padding: 1rem !important; background: white !important; color: black !important;
            }
            .expanded-card .close-button, .expanded-card .actions,
            .expanded-card .add-new-item-btn, .expanded-card .add-step-card-btn,
            .expanded-card [data-action="print"] { display: none !important; }
            .card h3, .historique strong { color: black !important; }
            .historique { border-left: 1px solid #ccc !important; background: #f9f9f9 !important; }
            input, textarea, [contenteditable="true"] {
                border: none !important; background: transparent !important;
                padding: 0 !important; margin: 0 !important; box-shadow: none !important; 
                -webkit-print-color-adjust: exact; color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 leading-relaxed min-h-screen flex flex-col">

    <header class="bg-gradient-to-r from-gray-800 to-blue-800 text-white p-4 text-center shadow-lg fixed top-0 w-full z-50 box-border flex flex-col rounded-b-lg">
        <div class="w-full flex items-center justify-between h-20">
            <div class="w-1/3"></div>
            <h1 class="w-1/3 text-center m-0 text-2xl md:text-3xl font-extrabold">Klaro</h1>
            <div class="w-1/3 flex flex-col items-end gap-1 mr-4">
                <span id="userIdDisplay" class="text-sm text-gray-300">Non connecté</span>
                <button id="authBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-all duration-300 ease-in-out shadow-sm">Connexion</button>
                <button id="signOutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-all duration-300 ease-in-out shadow-sm hidden">Déconnexion</button>
            </div>
        </div>
        <div id="modeSelector" class="mode-selector flex justify-center gap-4 py-3 hidden">
            <button data-mode="pro" class="active">🏢 Pro</button>
            <button data-mode="perso">🏠 Perso</button>
        </div>
    </header>

    <nav id="nav-pro" class="flex flex-wrap justify-center bg-gray-700 shadow-md fixed top-[148px] w-full z-40 box-border h-auto md:h-12 rounded-b-md hidden">
        <button class="nav-button" data-target="objectifs"><span class="mr-2">🎯</span>Objectifs</button>
        <button class="nav-button" data-target="actions"><span class="mr-2">📝</span>TO DO</button>
        <button class="nav-button" data-target="actionsTerminees"><span class="mr-2">✅</span>Terminées</button>
        <button class="nav-button" data-target="notesReunion"><span class="mr-2">📋</span>Notes</button>
        <button class="nav-button" data-target="sharedItems"><span class="mr-2">🌐</span>Partagés</button>
    </nav>
    
    <nav id="nav-perso" class="flex flex-wrap justify-center bg-teal-800 shadow-md fixed top-[148px] w-full z-40 box-border h-auto md:h-12 rounded-b-md hidden">
        <button class="nav-button" data-target="todo_perso"><span class="mr-2">📌</span>TODO</button>
        <button class="nav-button" data-target="voyages"><span class="mr-2">✈️</span>Voyages</button>
        <button class="nav-button" data-target="notes_perso"><span class="mr-2">🗒️</span>Notes</button>
        <button class="nav-button" data-target="courses"><span class="mr-2">🛒</span>Courses</button>
    </nav>
    
    <main class="flex-grow pt-52 md:pt-56 pb-8 hidden">
        <div id="objectifs" class="content hidden"></div>
        <div id="actions" class="content hidden"></div>
        <div id="actionsTerminees" class="content hidden"></div>
        <div id="notesReunion" class="content hidden"></div>
        <div id="sharedItems" class="content hidden"></div>
        <div id="todo_perso" class="content hidden"></div>
        <div id="voyages" class="content hidden"></div>
        <div id="notes_perso" class="content hidden"></div>
        <div id="courses" class="content hidden"></div>
    </main>
    
    <template id="page-template">
        <div class="p-4 md:p-8 max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 class="page-title text-3xl font-bold text-gray-800"></h2>
                    <p class="page-description text-gray-600 mt-1"></p>
                </div>
                <button class="add-new-item-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg cursor-pointer text-lg block w-full md:w-auto whitespace-nowrap shadow-md transition-transform hover:scale-105">➕ Ajouter</button>
            </div>
             <input type="text" class="searchBar w-full p-3 mb-6 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Rechercher...">
            <div class="grid-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-4"></div>
        </div>
    </template>
    
    <template id="card-template-base">
        <div class="card bg-white p-5 rounded-xl shadow-lg cursor-pointer transition-all duration-300 ease-in-out relative flex flex-col border border-gray-200 hover:-translate-y-1.5 hover:shadow-2xl">
            <span class="card-icon absolute top-3 right-4 text-2xl opacity-40"></span>
            <div class="card-content flex-grow flex flex-col">
                <h3 class="card-title text-xl font-bold text-gray-800 mb-2 break-words pr-6"></h3>
                <div class="card-summary text-gray-600 text-sm flex-grow"></div>
                <div class="tags-display mt-auto pt-3 text-sm flex flex-wrap gap-1"></div>
            </div>
            <div class="hidden-detail hidden flex-grow pt-4 border-t border-gray-200 mt-4"></div>
        </div>
    </template>
    
    <div class="overlay hidden fixed inset-0 w-full h-full bg-black bg-opacity-60 z-[1000] backdrop-blur-sm animate-fadein" id="overlay"></div>

    <div id="authModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded-lg shadow-2xl z-[2000] max-w-md w-11/12 hidden animate-expand">
        <span class="close-button absolute top-4 right-5 text-3xl font-bold text-gray-400 cursor-pointer">&times;</span>
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Connexion / Inscription</h3>
        <div class="mb-4">
            <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
            <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3" placeholder="votre@email.com" autocomplete="email">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Mot de passe:</label>
            <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3" placeholder="********" autocomplete="current-password">
        </div>
        <div class="flex flex-col gap-3">
            <button id="signInEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Se connecter</button>
            <button id="signUpEmailBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">S'inscrire</button>
            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink mx-4 text-gray-400">OU</span><div class="flex-grow border-t border-gray-300"></div>
            </div>
            <button id="signInGoogleBtn" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded shadow-md flex items-center justify-center gap-2 border">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5"> Se connecter avec Google
            </button>
        </div>
    </div>
    
<script type="module">
    // Importe les modules Firebase nécessaires.
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, addDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // --- CONFIGURATION & CONSTANTES ---
    const firebaseConfig = {
        apiKey: "AIzaSyCFMC73NLlmTzGVGcK_-zTwwNyw6-jmr7Y",
        authDomain: "suivitravailapp.firebaseapp.com",
        projectId: "suivitravailapp",
        storageBucket: "suivitravailapp.appspot.com",
        messagingSenderId: "621525076182",
        appId: "1:621525076182:web:f5a9bc1f5aaae71ce7e177",
        measurementId: "G-15HMDGYYCN"
    };

    const COLLECTIONS_PRO = {
        OBJECTIFS: 'objectifs',
        ACTIONS: 'actions',
        NOTES_REUNION: 'notesReunion',
        SHARED_ENTRIES: 'shared_entries'
    };

    const COLLECTIONS_PERSO = {
        TODO: 'todo_perso',
        VOYAGES: 'voyages',
        NOTES: 'notes_perso',
        COURSES: 'courses'
    };
    
    const PAGE_CONFIG = {
        // Pro
        objectifs: { title: 'Objectifs', description: 'Suivez vos objectifs principaux et leur progression.', type: COLLECTIONS_PRO.OBJECTIFS, icon: '🎯', mode: 'pro' },
        actions: { title: 'TO DO Pro', description: 'Gérez vos tâches et actions à réaliser.', type: COLLECTIONS_PRO.ACTIONS, icon: '📝', mode: 'pro' },
        actionsTerminees: { title: 'Actions Terminées', description: 'Consultez les actions que vous avez achevées.', type: COLLECTIONS_PRO.ACTIONS, icon: '✅', mode: 'pro' },
        notesReunion: { title: 'Notes de Réunion', description: 'Archivez et retrouvez toutes vos notes.', type: COLLECTIONS_PRO.NOTES_REUNION, icon: '📋', mode: 'pro' },
        sharedItems: { title: 'Éléments Partagés', description: 'Ces éléments ont été partagés publiquement. Ils sont en lecture seule.', type: COLLECTIONS_PRO.SHARED_ENTRIES, icon: '🌐', mode: 'pro' },
        // Perso
        todo_perso: { title: 'TODO Perso', description: 'Vos tâches personnelles.', type: COLLECTIONS_PERSO.TODO, icon: '📌', mode: 'perso' },
        voyages: { title: 'Voyages', description: 'Planifiez vos prochaines escapades.', type: COLLECTIONS_PERSO.VOYAGES, icon: '✈️', mode: 'perso' },
        notes_perso: { title: 'Notes Perso', description: 'Vos pensées et mémos personnels.', type: COLLECTIONS_PERSO.NOTES, icon: '🗒️', mode: 'perso' },
        courses: { title: 'Liste de Courses', description: 'N\'oubliez plus rien au supermarché.', type: COLLECTIONS_PERSO.COURSES, icon: '🛒', mode: 'perso' },
    };

    // --- INITIALISATION FIREBASE ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // --- VARIABLES GLOBALES & SÉLECTEURS DOM ---
    let userId = null;
    let expandedCard = null;
    let currentMode = 'pro';
    let currentPageId = 'objectifs';
    let unsubscribeListeners = [];
    let allDataCache = {};
    
    const authModal = document.getElementById('authModal');
    const overlay = document.getElementById('overlay');
    const mainContent = document.querySelector('main');
    const navPro = document.getElementById('nav-pro');
    const navPerso = document.getElementById('nav-perso');
    const modeSelector = document.getElementById('modeSelector');
    const pageTemplate = document.getElementById('page-template');
    const cardTemplate = document.getElementById('card-template-base');

    // --- FONCTIONS UTILITAIRES & MODALES ---
    function showToastNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = 'toast-notification fixed bottom-5 left-1/2 -translate-x-1/2 text-white px-5 py-3 rounded-lg shadow-xl z-[3000] opacity-0 animate-fadeinout text-base flex items-center gap-2';
        const icons = { success: '✔️', error: '❌', info: 'ℹ️' };
        const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
        
        toast.classList.add(colors[type] || colors.info);
        toast.innerHTML = `${icons[type] || icons.info} ${message}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    async function showConfirmationModal(message, confirmText = "Oui", cancelText = "Non") {
        return new Promise(resolve => {
            const modalContainer = document.createElement('div');
            modalContainer.id = "confirmation-modal";
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-[2999] animate-fadein"></div>
                <div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl z-[3000] text-center max-w-sm w-11/12 animate-expand">
                    <p class="mb-5 text-gray-800">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button class="confirm-yes bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded">${confirmText}</button>
                        <button class="confirm-no bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">${cancelText}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalContainer);

            const cleanup = (result) => {
                modalContainer.remove();
                resolve(result);
            };

            modalContainer.querySelector('.confirm-yes').onclick = () => cleanup(true);
            modalContainer.querySelector('.confirm-no').onclick = () => cleanup(false);
            modalContainer.firstElementChild.onclick = () => cleanup(false);
        });
    }
    
    const getTimeStamp = () => new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'medium' });
    
    // --- GESTION DE L'AUTHENTIFICATION ---
    onAuthStateChanged(auth, user => {
        const authModalCloseBtn = authModal.querySelector('.close-button');
        if (user) {
            userId = user.uid;
            document.getElementById('userIdDisplay').innerText = user.email || 'Connecté';
            document.getElementById('authBtn').classList.add('hidden');
            document.getElementById('signOutBtn').classList.remove('hidden');
            closeAuthModal();
            authModalCloseBtn.classList.remove('hidden');  
            mainContent.classList.remove('hidden');
            modeSelector.classList.remove('hidden');
            setupRealtimeListeners();
            setMode(currentMode);
        } else {
            userId = null;
            document.getElementById('userIdDisplay').innerText = 'Non connecté';
            document.getElementById('authBtn').classList.remove('hidden');
            document.getElementById('signOutBtn').classList.add('hidden');
            mainContent.classList.add('hidden');
            modeSelector.classList.add('hidden');
            navPro.classList.add('hidden');
            navPerso.classList.add('hidden');
            document.querySelectorAll('.content').forEach(container => container.innerHTML = '');
            detachRealtimeListeners(); 
            openAuthModal();
            authModalCloseBtn.classList.add('hidden');
        }
    });

    const openAuthModal = () => { authModal.classList.remove('hidden'); overlay.classList.remove('hidden'); };
    const closeAuthModal = () => {
        if (!authModal.classList.contains('hidden')) {
            authModal.classList.add('hidden');
            if(!expandedCard) overlay.classList.add('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }
    };
    
    // --- GESTION DES DONNÉES (FIRESTORE) ---
    function detachRealtimeListeners() {
        unsubscribeListeners.forEach(unsubscribe => unsubscribe());
        unsubscribeListeners = [];
    }

    function setupRealtimeListeners() {
        if (!userId) return;
        detachRealtimeListeners();

        const createListener = (collectionName, cacheKey, isPublic = false) => {
            const path = isPublic 
                ? `artifacts/${firebaseConfig.appId}/public/data/${collectionName}`
                : `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`;
            const q = query(collection(db, path));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                allDataCache[cacheKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const pageConfig = PAGE_CONFIG[currentPageId];
                if (pageConfig && (pageConfig.type === collectionName || (currentPageId === 'actionsTerminees' && collectionName === COLLECTIONS_PRO.ACTIONS))) {
                     triggerRenderForCurrentPage();
                }
            }, (error) => {
                console.error(`Error listening to ${collectionName}:`, error);
                showToastNotification(`Erreur de permissions pour ${collectionName}.`, 'error');
            });
            unsubscribeListeners.push(unsubscribe);
        };
        
        // Listen to all collections
        Object.values(COLLECTIONS_PRO).forEach(name => createListener(name, name, name === COLLECTIONS_PRO.SHARED_ENTRIES));
        Object.values(COLLECTIONS_PERSO).forEach(name => createListener(name, name));
    }
    
    // --- LOGIQUE DE RENDU ET D'INTERFACE ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-selector button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });

        if (mode === 'pro') {
            navPro.classList.remove('hidden');
            navPerso.classList.add('hidden');
            showPage('objectifs');
        } else {
            navPro.classList.add('hidden');
            navPerso.classList.remove('hidden');
            showPage('todo_perso');
        }
    }

    function showPage(id) {
        if(expandedCard) closeExpandedCard();

        currentPageId = id;
        document.querySelectorAll('.content').forEach(section => {
            section.classList.add('hidden');
            section.innerHTML = '';
        });
        
        const activePage = document.getElementById(id);
        if (!activePage) return;
        
        const config = PAGE_CONFIG[id];
        const pageFragment = pageTemplate.content.cloneNode(true);
        pageFragment.querySelector('.page-title').textContent = config.title;
        pageFragment.querySelector('.page-description').textContent = config.description;
        pageFragment.querySelector('.searchBar').dataset.page = id;
        const addButton = pageFragment.querySelector('.add-new-item-btn');
        if (addButton) {
            addButton.dataset.type = config.type;
            if (id === 'actionsTerminees' || id === 'sharedItems') {
                addButton.remove();
            }
        }
        
        activePage.appendChild(pageFragment);
        activePage.classList.remove('hidden');

        const activeNav = currentMode === 'pro' ? navPro : navPerso;
        activeNav.querySelectorAll('.nav-button').forEach(button => {
            button.classList.toggle('active', button.dataset.target === id);
        });
        triggerRenderForCurrentPage();
    }
    
    function triggerRenderForCurrentPage() {
        if (expandedCard) return;
        const pageElement = document.getElementById(currentPageId);
        if(!pageElement) return;

        const searchInput = pageElement.querySelector('.searchBar');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
        const config = PAGE_CONFIG[currentPageId];
        if (!config) return;

        const options = { searchTerm, isReadOnly: false, displayCompleted: false };
        let data = allDataCache[config.type] || [];
        
        if (currentPageId === 'actionsTerminees') {
            options.displayCompleted = true;
        }
        if (currentPageId === 'sharedItems') {
            options.isReadOnly = true;
        }
        
        renderEntries(currentPageId, data, options);
    }

    function renderEntries(containerId, data, options) {
        const container = document.querySelector(`#${containerId} .grid-container`);
        if (!container) return;
        container.innerHTML = '';

        const filteredData = data.filter(entry => {
            const pageConfig = PAGE_CONFIG[containerId];
            if (!pageConfig) return false;

            if (pageConfig.type === COLLECTIONS_PRO.ACTIONS && (!!entry.isCompleted !== options.displayCompleted)) return false;
            if (pageConfig.type === COLLECTIONS_PERSO.TODO && (!!entry.isCompleted !== options.displayCompleted)) return false;
            
            if (options.searchTerm) {
                return JSON.stringify(entry).toLowerCase().includes(options.searchTerm);
            }
            return true;
        });

        if (filteredData.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 col-span-full mt-12 text-lg">📂<br>${options.searchTerm ? 'Aucun résultat trouvé.' : 'Rien à afficher ici pour le moment.'}</p>`;
            return;
        }

        filteredData.forEach(entry => {
            const cardDiv = createCardElement(entry, options.isReadOnly);
            container.appendChild(cardDiv);
        });
    }
    
    function createCardElement(entry, isReadOnly) {
        const card = cardTemplate.content.cloneNode(true).firstElementChild;
        const originalType = isReadOnly ? entry.originalCollection : PAGE_CONFIG[currentPageId].type;
        
        card.dataset.id = entry.id;
        card.dataset.type = originalType;
        card.dataset.readonly = isReadOnly;

        card.querySelector('.card-title').textContent = entry.titre || 'Sans titre';
        const pageKey = Object.keys(PAGE_CONFIG).find(k => PAGE_CONFIG[k].type === originalType)
        card.querySelector('.card-icon').textContent = PAGE_CONFIG[pageKey]?.icon || '❓';

        const summaryEl = card.querySelector('.card-summary');
        if (originalType === COLLECTIONS_PRO.OBJECTIFS) {
            const pct = entry.pourcentage || 0;
            const progressClass = pct < 25 ? 'bg-red-500' : (pct < 75 ? 'bg-yellow-500' : 'bg-green-500');
            summaryEl.innerHTML = `<div class="bg-gray-200 rounded-full h-6 my-2 shadow-inner"><div class="h-full text-center text-white font-bold text-sm leading-6 transition-all duration-500 ${progressClass}" style="width: ${pct}%">${pct}%</div></div>`;
        } else if (originalType === COLLECTIONS_PRO.ACTIONS) {
            let summaryContent = '';
            if (entry.deadLine) {
                summaryContent += `<span>Deadline: <strong class="${new Date() > new Date(entry.deadLine) && !entry.isCompleted ? 'deadline-overdue' : ''}">${new Date(new Date(entry.deadLine).toLocaleString('en-US',{timeZone:'Europe/Paris'})).toLocaleDateString('fr-FR')}</strong></span>`;
            } else {
                summaryContent += 'Aucune deadline.';
            }
            if (entry.contenu) {
                summaryContent += `<p class="mt-2 text-xs italic text-gray-500">${entry.contenu.substring(0, 80)}...</p>`;
            }
            summaryEl.innerHTML = summaryContent;
        } else if (originalType === COLLECTIONS_PERSO.TODO) {
            if (entry.contenu) {
                summaryEl.textContent = `${entry.contenu.substring(0, 120)}...`;
            }
        } else if ([COLLECTIONS_PRO.NOTES_REUNION, COLLECTIONS_PERSO.NOTES, COLLECTIONS_PERSO.VOYAGES].includes(originalType)) {
            summaryEl.textContent = `${(entry.contenu || '').substring(0, 120)}...`;
        } else if (originalType === COLLECTIONS_PERSO.COURSES) {
            const items = entry.items || [];
            const completedItems = items.filter(item => item.completed).length;
            summaryEl.textContent = `${completedItems} / ${items.length} articles cochés`;
        }

        const tagsContainer = card.querySelector('.tags-display');
        (entry.tags || []).forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'tag-item bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs font-semibold';
            tagEl.textContent = tag;
            tagsContainer.appendChild(tagEl);
        });
        
        return card;
    }

    // --- CARD EXPANSION & MODAL LOGIC ---
    
function closeExpandedCard() {
    if (!expandedCard) return;

    overlay.classList.add('hidden');

    expandedCard.classList.remove(
        'expanded-card', 'fixed', 'top-1/2', 'left-1/2',
        'w-[95%]', 'h-[90%]', 'overflow-y-auto', 'p-8', 'shadow-2xl',
        'z-[1001]', 'animate-expand', '-translate-x-1/2', '-translate-y-1/2'
    );

    // Restaurer la carte à son emplacement initial
    if (expandedCard._originalParent) {
        if (expandedCard._originalNextSibling) {
            expandedCard._originalParent.insertBefore(expandedCard, expandedCard._originalNextSibling);
        } else {
            expandedCard._originalParent.appendChild(expandedCard);
        }
    }

    const detailView = expandedCard.querySelector('.hidden-detail');
    if (detailView) {
        detailView.classList.add('hidden');
        detailView.innerHTML = '';
    }

    const closeButton = expandedCard.querySelector('.close-button');
    if (closeButton) closeButton.remove();

    expandedCard = null;
    triggerRenderForCurrentPage();
}


    function openNewItemModal(type) {
        if (expandedCard) closeExpandedCard();

        const modal = document.createElement('div');
        modal.id = 'new-item-modal';
        // MODIFICATION ICI: max-w-3xl a été remplacé par max-w-6xl
        modal.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-6xl bg-white p-6 rounded-lg shadow-2xl z-[1001] animate-expand h-auto max-h-5/6 overflow-y-auto';
        
        let formHtml = '';
        const config = Object.values(PAGE_CONFIG).find(p => p.type === type);
        if (!config) return;

        formHtml += `<h3 class="text-2xl font-bold text-gray-800 mb-6">${config.icon} Ajouter: ${config.title}</h3>`;
        
        formHtml += `<div class="mb-4">
                        <label for="new-titre" class="block text-sm font-bold text-gray-700 mb-1">Titre</label>
                        <input type="text" id="new-titre" placeholder="Titre de l'élément" required class="editable-field !mb-0">
                     </div>`;
        
        if (type === COLLECTIONS_PRO.OBJECTIFS) {
            formHtml += `<div class="mb-4">
                            <label for="new-description" class="block text-sm font-bold text-gray-700 mb-1">Description</label>
                            <textarea id="new-description" placeholder="Description de l'objectif" class="editable-field !mb-0 min-h-[150px]"></textarea>
                         </div>`;
            formHtml += `<div class="mb-4">
                            <label for="new-pourcentage" class="block text-sm font-bold text-gray-700 mb-1">Pourcentage</label>
                            <input type="range" id="new-pourcentage" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                         </div>`;
        } else if (type === COLLECTIONS_PRO.ACTIONS) {
            formHtml += `<div class="mb-4">
                            <label for="new-contenu" class="block text-sm font-bold text-gray-700 mb-1">Contenu / Description</label>
                            <textarea id="new-contenu" placeholder="Détails de la tâche..." class="editable-field !mb-0 min-h-[120px]"></textarea>
                         </div>`;
            formHtml += `<div class="mb-4">
                            <label for="new-deadLine" class="block text-sm font-bold text-gray-700 mb-1">Deadline</label>
                            <input type="date" id="new-deadLine" class="editable-field !mb-0">
                         </div>`;
        } else if (type === COLLECTIONS_PERSO.TODO) {
            formHtml += `<div class="mb-4">
                            <label for="new-contenu" class="block text-sm font-bold text-gray-700 mb-1">Contenu / Description</label>
                            <textarea id="new-contenu" placeholder="Détails de la tâche..." class="editable-field !mb-0 min-h-[120px]"></textarea>
                         </div>`;
        } else if ([COLLECTIONS_PRO.NOTES_REUNION, COLLECTIONS_PERSO.NOTES, COLLECTIONS_PERSO.VOYAGES].includes(type)) {
            formHtml += `<div class="mb-4">
                            <label for="new-contenu" class="block text-sm font-bold text-gray-700 mb-1">Contenu</label>
                            <textarea id="new-contenu" placeholder="Contenu de la note" class="editable-field !mb-0 min-h-[200px]"></textarea>
                         </div>`;
        } else if (type === COLLECTIONS_PERSO.COURSES) {
            formHtml += `<div class="mb-4">
                            <label for="new-items" class="block text-sm font-bold text-gray-700 mb-1">Articles (un par ligne)</label>
                            <textarea id="new-items" placeholder="Lait\nOeufs\nPain" class="editable-field !mb-0 min-h-[200px]"></textarea>
                         </div>`;
        }
        
        if (type !== COLLECTIONS_PERSO.COURSES) {
            formHtml += `<div class="mb-4">
                            <label for="new-tags" class="block text-sm font-bold text-gray-700 mb-1">Tags</label>
                            <input type="text" id="new-tags" placeholder="marketing, projet_alpha, urgent" class="editable-field !mb-0">
                         </div>`;
        }

        formHtml += `
            <div class="flex justify-end gap-4 mt-8 pt-4 border-t">
                <button type="button" class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Annuler</button>
                <button type="submit" class="submit-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Ajouter</button>
            </div>`;
        
        const form = document.createElement('form');
        form.innerHTML = formHtml;
        modal.appendChild(form);
        
        document.body.appendChild(modal);
        expandedCard = modal;
        overlay.classList.remove('hidden');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            addEntry(type);
        });
        modal.querySelector('.cancel-btn').addEventListener('click', closeExpandedCard);
    }



function toggleCardExpansion(cardElement) {
    if (expandedCard) closeExpandedCard();

    expandedCard = cardElement;
    const { id, type, readonly } = cardElement.dataset;
    const isReadOnly = readonly === 'true';
    const entry = allDataCache[type] ? allDataCache[type].find(item => item.id === id) : null;
    if (!entry) return;

    // Sauvegarder la position initiale
    expandedCard._originalParent = cardElement.parentNode;
    expandedCard._originalNextSibling = cardElement.nextSibling;

    // Déplacer la carte dans le body pour éviter les contraintes de la grille
    document.body.appendChild(cardElement);

    // Appliquer les styles plein écran avec gestion du contenu long
    cardElement.classList.add(
        'expanded-card', 'fixed', 'top-4', 'left-1/2',
        'w-[95%]', 'max-h-[90%]', 'overflow-y-auto', 'p-8', 'shadow-2xl',
        'z-[1001]', 'animate-expand', '-translate-x-1/2'
    );

    overlay.classList.remove('hidden');

    const detailContainer = cardElement.querySelector('.hidden-detail');
    detailContainer.innerHTML = buildDetailView(entry, type, isReadOnly);
    detailContainer.classList.remove('hidden');

    const closeButton = document.createElement('span');
    closeButton.className = 'close-button sticky top-0 right-0 float-right text-3xl font-bold text-gray-400 cursor-pointer z-[1002] bg-white bg-opacity-80 px-2 rounded-full';
    closeButton.innerHTML = '&times;';
    closeButton.onclick = closeExpandedCard;
    cardElement.prepend(closeButton);
}




function buildDetailView(entry, type, isReadOnly) {
        let detailsHtml = `<h3 class="text-2xl font-bold text-gray-800 mb-4">${entry.titre}</h3>`;
        
        if (type === COLLECTIONS_PRO.OBJECTIFS) {
            detailsHtml += `<label class="text-sm font-bold text-gray-700">Description</label><textarea data-field="description" class="editable-field min-h-[150px]">${entry.description || ''}</textarea>`;
            detailsHtml += `<label class="text-sm font-bold text-gray-700">Pourcentage: <span class="font-bold">${entry.pourcentage || 0}%</span></label><input type="range" data-field="pourcentage" min="0" max="100" value="${entry.pourcentage || 0}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-4">`;
        } else if (type === COLLECTIONS_PRO.ACTIONS || type === COLLECTIONS_PERSO.TODO) {
            detailsHtml += `<label class="text-sm font-bold text-gray-700">Contenu / Description</label><textarea data-field="contenu" class="editable-field min-h-[150px]">${entry.contenu || ''}</textarea>`;
            if (type === COLLECTIONS_PRO.ACTIONS) {
                detailsHtml += `<label class="text-sm font-bold text-gray-700">Deadline</label><input type="date" data-field="deadLine" value="${entry.deadLine || ''}" class="editable-field">`;
            }
        } else if ([COLLECTIONS_PRO.NOTES_REUNION, COLLECTIONS_PERSO.NOTES, COLLECTIONS_PERSO.VOYAGES].includes(type)) {
            // La seule modification est ici : la classe de la textarea
            detailsHtml += `<label class="text-sm font-bold text-gray-700">Contenu</label><textarea data-field="contenu" class="editable-field !h-[60vh]">${entry.contenu || ''}</textarea>`;
        } else if (type === COLLECTIONS_PERSO.COURSES) {
            detailsHtml += `<div class="courses-list mb-4"></div>`; // Container for dynamic items
            detailsHtml += `<form class="add-course-item-form flex gap-2"><input type="text" placeholder="Nouvel article" class="editable-field !mb-0 flex-grow"><button type="submit" class="bg-blue-500 text-white px-4 rounded-md">Ajouter</button></form>`;
            setTimeout(() => {
                const listContainer = expandedCard.querySelector('.courses-list');
                if (listContainer) renderCourseItems(listContainer, entry.items || []);
            }, 0);
        }
        
        if (type !== COLLECTIONS_PERSO.COURSES) {
             detailsHtml += `<label class="text-sm font-bold text-gray-700">Tags</label><input type="text" data-field="tags" value="${(entry.tags || []).join(', ')}" class="editable-field">`;
        }

        let actionsHtml = `<div class="actions flex flex-wrap gap-3 mt-6 justify-end pt-4 border-t">`;
        if (!isReadOnly) {
            if ([COLLECTIONS_PRO.ACTIONS, COLLECTIONS_PERSO.TODO].includes(type)) {
                if (entry.isCompleted) {
                    actionsHtml += `<button data-action="markAsCompleted" data-value="false" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">↩️ Ré-ouvrir</button>`;
                } else {
                    actionsHtml += `<button data-action="markAsCompleted" data-value="true" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">✅ Terminer</button>`;
                }
            }
            if (currentMode === 'pro') {
                actionsHtml += `<button data-action="share" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">🔗 Partager</button>`;
            }
            actionsHtml += `<button data-action="delete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">🗑️ Supprimer</button>`;
        }
        actionsHtml += `<button data-action="print" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">🖨️ Imprimer</button>`;
        actionsHtml += `</div>`;
        detailsHtml += actionsHtml;

        const historyHtml = (entry.historique || []).slice().reverse().map(line => `<li>• ${line}</li>`).join('');
        detailsHtml += `<div class="historique text-sm text-gray-600 mt-6 bg-gray-100 p-4 border-l-4 border-blue-600 rounded-md max-h-40 overflow-y-auto"><strong>Historique :</strong><ul class="list-none pl-0 mt-2">${historyHtml}</ul></div>`;

        return detailsHtml;
    }    function renderCourseItems(container, items) {
        container.innerHTML = items.map((item, index) => `
            <div class="course-item flex items-center justify-between p-2 hover:bg-gray-100 rounded-md">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" data-item-index="${index}" ${item.completed ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-3 text-gray-700">${item.text}</span>
                </label>
                <button data-action="delete-course-item" data-item-index="${index}" class="text-gray-400 hover:text-red-500">🗑️</button>
            </div>
        `).join('');
    }
    
    // --- CRUD OPERATIONS ---
    async function addEntry(collectionName) {
        if (!userId || !expandedCard) return;
        const titre = expandedCard.querySelector('#new-titre').value.trim();
        if (!titre) {
            showToastNotification("Le titre est obligatoire.", "error");
            return;
        }
        const newEntry = {
            titre,
            historique: [`Créé le ${getTimeStamp()}`],
            createdAt: new Date().toISOString()
        };

        const tagsInput = expandedCard.querySelector('#new-tags');
        if (tagsInput) {
            newEntry.tags = tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
        }

        if (collectionName === COLLECTIONS_PRO.OBJECTIFS) {
            newEntry.description = expandedCard.querySelector('#new-description').value.trim();
            newEntry.pourcentage = parseInt(expandedCard.querySelector('#new-pourcentage').value) || 0;
        } else if (collectionName === COLLECTIONS_PRO.ACTIONS) {
            newEntry.contenu = expandedCard.querySelector('#new-contenu').value.trim();
            newEntry.deadLine = expandedCard.querySelector('#new-deadLine').value || '';
            newEntry.isCompleted = false;
        } else if ([COLLECTIONS_PRO.NOTES_REUNION, COLLECTIONS_PERSO.NOTES, COLLECTIONS_PERSO.VOYAGES].includes(collectionName)) {
            newEntry.contenu = expandedCard.querySelector('#new-contenu').value.trim();
        } else if ([COLLECTIONS_PERSO.TODO].includes(collectionName)) {
            newEntry.contenu = expandedCard.querySelector('#new-contenu').value.trim();
            newEntry.isCompleted = false;
        } else if (collectionName === COLLECTIONS_PERSO.COURSES) {
            newEntry.items = expandedCard.querySelector('#new-items').value.split('\n').map(text => ({ text: text.trim(), completed: false })).filter(item => item.text);
        }

        try {
            const path = `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`;
            await addDoc(collection(db, path), newEntry);
            showToastNotification("Élément ajouté avec succès !", 'success');
            closeExpandedCard();
        } catch (error) {
            console.error("Error adding document: ", error);
            showToastNotification("Erreur lors de l'ajout.", "error");
        }
    }

    async function handleUpdate(collectionName, id, field, value) {
        if (!userId) return;
        const path = `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`;
        const docRef = doc(db, path, id);
        try {
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return;
            
            let updateValue = value;
            if (field === 'tags') {
                updateValue = value.split(',').map(t => t.trim()).filter(Boolean);
            } else if (field === 'pourcentage') {
                updateValue = parseInt(value, 10);
            }

            const newHistoryEntry = `Champ '${field}' mis à jour le ${getTimeStamp()}`;
            const updates = {
                [field]: updateValue,
                historique: [...(docSnap.data().historique || []), newHistoryEntry]
            };
            await updateDoc(docRef, updates);
            showToastNotification("Mise à jour réussie.", 'success');
        } catch (error) {
            console.error("Error updating document: ", error);
            showToastNotification("Erreur de mise à jour.", "error");
        }
    }

    async function updateCourseItems(id, newItems) {
        if (!userId) return;
        const path = `artifacts/${firebaseConfig.appId}/users/${userId}/${COLLECTIONS_PERSO.COURSES}`;
        const docRef = doc(db, path, id);
        try {
            await updateDoc(docRef, { items: newItems });
        } catch(e) {
            console.error("Error updating course items: ", e);
            showToastNotification("Erreur de mise à jour des articles.", "error");
        }
    }

    async function deleteEntry(collectionName, id) {
        if (!userId) return;
        const confirmed = await showConfirmationModal("Êtes-vous sûr de vouloir supprimer cet élément définitivement ?");
        if (confirmed) {
            const path = `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`;
            try {
                await deleteDoc(doc(db, path, id));
                showToastNotification("Élément supprimé.", 'success');
                closeExpandedCard();
            } catch (error) {
                console.error("Error deleting document: ", error);
                showToastNotification("Erreur de suppression.", "error");
            }
        }
    }

    async function markAsCompleted(collectionName, id, isCompleted) {
        if (!userId) return;
        const path = `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}`;
        const docRef = doc(db, path, id);
        try {
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return;
            const newHistoryEntry = `Marqué comme ${isCompleted ? 'terminé' : 'non terminé'} le ${getTimeStamp()}`;
            await updateDoc(docRef, {
                isCompleted,
                historique: [...(docSnap.data().historique || []), newHistoryEntry]
            });
            showToastNotification(`Action mise à jour.`, 'success');
            closeExpandedCard();
        } catch (error) {
            console.error("Error updating completion: ", error);
            showToastNotification("Erreur de mise à jour.", "error");
        }
    }

    async function shareEntry(collectionName, id) {
        if (!userId) return;
        const confirmed = await showConfirmationModal("Partager cet élément le rendra visible publiquement. Continuer ?");
        if (confirmed) {
            const userDocPath = `artifacts/${firebaseConfig.appId}/users/${userId}/${collectionName}/${id}`;
            const publicDocPath = `artifacts/${firebaseConfig.appId}/public/data/${COLLECTIONS_PRO.SHARED_ENTRIES}`;
            try {
                const docSnap = await getDoc(doc(db, userDocPath));
                if (docSnap.exists()) {
                    const dataToShare = {
                        ...docSnap.data(),
                        originalCollection: collectionName,
                        originalUserId: userId,
                        sharedAt: getTimeStamp()
                    };
                    await addDoc(collection(db, publicDocPath), dataToShare);
                    showToastNotification("Élément partagé avec succès !", 'success');
                }
            } catch (error) {
                console.error("Error sharing document: ", error);
                showToastNotification("Erreur lors du partage.", "error");
            }
        }
    }


    // --- EVENT LISTENERS ---
    function initializeEventListeners() {
        // --- Auth Buttons ---
        document.getElementById('signInEmailBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, password); showToastNotification('Connexion réussie !', 'success'); } 
            catch (error) { showToastNotification(`Erreur: ${error.code}`, 'error'); }
        });
        document.getElementById('signUpEmailBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try { await createUserWithEmailAndPassword(auth, email, password); showToastNotification('Inscription réussie !', 'success'); } 
            catch (error) { showToastNotification(`Erreur: ${error.code}`, 'error'); }
        });
        document.getElementById('signInGoogleBtn').addEventListener('click', async () => {
            try { await signInWithPopup(auth, googleProvider); showToastNotification('Connexion Google réussie !', 'success'); } 
            catch (error) { showToastNotification(`Erreur: ${error.code}`, 'error'); }
        });
        document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth).then(() => showToastNotification('Déconnecté.', 'info')));

        // --- Static UI Elements ---
        document.getElementById('authBtn').addEventListener('click', openAuthModal);
        authModal.querySelector('.close-button').addEventListener('click', closeAuthModal);
        overlay.addEventListener('click', () => { closeAuthModal(); closeExpandedCard(); });
        
        modeSelector.addEventListener('click', e => {
            const button = e.target.closest('button');
            if(button) setMode(button.dataset.mode);
        });

        navPro.addEventListener('click', e => {
            const button = e.target.closest('.nav-button');
            if (button) showPage(button.dataset.target);
        });
        navPerso.addEventListener('click', e => {
            const button = e.target.closest('.nav-button');
            if (button) showPage(button.dataset.target);
        });

        // --- Event Delegation for Dynamic Content ---
        mainContent.addEventListener('input', e => {
             if(e.target.matches('.searchBar')) {
                triggerRenderForCurrentPage();
             }
        });
        
        mainContent.addEventListener('click', e => {
            const card = e.target.closest('.card:not(.expanded-card)');
            if (card) {
                if (!e.target.closest('button, a, input, textarea, [contenteditable]')) {
                    toggleCardExpansion(card);
                }
                return;
            }

            const addNewButton = e.target.closest('.add-new-item-btn');
            if (addNewButton) {
                openNewItemModal(addNewButton.dataset.type);
                return;
            }

            if (expandedCard) {
                const actionButton = e.target.closest('[data-action]');
                if (actionButton) {
                    const { action, value } = actionButton.dataset;
                    const { id, type } = expandedCard.dataset;
                    switch(action) {
                        case 'delete': deleteEntry(type, id); break;
                        case 'share': shareEntry(type, id); break;
                        case 'print': window.print(); break;
                        case 'markAsCompleted': markAsCompleted(type, id, value === 'true'); break;
                        case 'delete-course-item': {
                            const entry = allDataCache[type].find(item => item.id === id);
                            if(entry) {
                                const itemIndex = parseInt(actionButton.dataset.itemIndex, 10);
                                const newItems = entry.items.filter((_, index) => index !== itemIndex);
                                updateCourseItems(id, newItems);
                                // Refresh view locally
                                const listContainer = expandedCard.querySelector('.courses-list');
                                if(listContainer) renderCourseItems(listContainer, newItems);
                            }
                            break;
                        }
                    }
                }
            }
        });
        
        document.body.addEventListener('submit', e => {
            if (expandedCard && e.target.matches('.add-course-item-form')) {
                e.preventDefault();
                const input = e.target.querySelector('input');
                const newItemText = input.value.trim();
                if (newItemText) {
                    const { id, type } = expandedCard.dataset;
                    const entry = allDataCache[type].find(item => item.id === id);
                    if (entry) {
                        const newItems = [...(entry.items || []), { text: newItemText, completed: false }];
                        updateCourseItems(id, newItems);
                        // Refresh view locally
                        const listContainer = expandedCard.querySelector('.courses-list');
                        if(listContainer) renderCourseItems(listContainer, newItems);
                        input.value = '';
                        input.focus();
                    }
                }
            }
        });

        document.body.addEventListener('change', e => {
            if (expandedCard && e.target.matches('[data-field="pourcentage"]')) {
                const field = e.target.dataset.field;
                const value = e.target.value;
                const { id, type } = expandedCard.dataset;
                handleUpdate(type, id, field, value);
            }
            if (expandedCard && e.target.matches('.course-item input[type="checkbox"]')) {
                const { id, type } = expandedCard.dataset;
                const entry = allDataCache[type].find(item => item.id === id);
                if (entry) {
                    const itemIndex = parseInt(e.target.dataset.itemIndex, 10);
                    const newItems = [...entry.items];
                    newItems[itemIndex].completed = e.target.checked;
                    updateCourseItems(id, newItems);
                }
            }
        });
        
        document.body.addEventListener('blur', e => {
            if (expandedCard && e.target.matches('.editable-field, [data-field="deadLine"], [data-field="tags"]')) {
                const field = e.target.dataset.field;
                const value = e.target.value;
                const { id, type } = expandedCard.dataset;
                handleUpdate(type, id, field, value);
            }
        }, true); // Use capture to ensure it fires
    }

    // --- Initialisation au chargement de la page ---
    document.addEventListener('DOMContentLoaded', initializeEventListeners);

</script>
</body>
</html>
